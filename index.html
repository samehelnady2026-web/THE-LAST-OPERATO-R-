<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#050508">
    <title>NINJA NEON PRO - CLOUD EDITION</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Ninja%20Neon%20Pro%22,%22short_name%22:%22Ninja%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#050508%22,%22theme_color%22:%22#00f2ff%22,%22icons%22:[{%22src%22:%22https://cdn-icons-png.flaticon.com/512/1141/1141771.png%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22}]}">

    <style>
        :root { --neon: #00f2ff; --gold: #f1c40f; --cash: #2ecc71; --vip: #e056fd; --bg: #050508; }
        body, html { margin: 0; padding: 0; overflow: hidden; background: var(--bg); font-family: 'Segoe UI', Tahoma; color: white; touch-action: none; }
        canvas { display: block; }

        /* Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© */
        .overlay-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; text-align: center; }
        .input-box { background: #111; border: 1.5px solid var(--neon); padding: 12px; border-radius: 12px; color: white; width: 260px; margin: 8px; text-align: center; outline: none; }
        
        /* Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„Ø³ÙƒÙ†Ø§Øª */
        .shop-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; max-width: 450px; margin-top: 15px; }
        .skin-item { background: #111; border: 2px solid #333; border-radius: 12px; padding: 10px; text-align: center; cursor: pointer; transition: 0.2s; }
        .skin-item.selected { border-color: var(--neon); box-shadow: 0 0 10px var(--neon); background: rgba(0,242,255,0.05); }
        .wallet-bar { background: rgba(255,255,255,0.05); border: 1px solid var(--neon); border-radius: 15px; padding: 15px; display: flex; gap: 20px; font-weight: bold; margin-bottom: 10px; }

        /* Ø§Ù„Ø´Ø±ÙƒØ§Ø¡ */
        .partners { margin-top: 30px; display: flex; gap: 15px; align-items: center; justify-content: center; filter: grayscale(1) opacity(0.6); }
        .partners a:hover { filter: grayscale(0) opacity(1); transform: scale(1.1); transition: 0.3s; }
        .orange-cash { background: #FF7900; color: white; font-size: 9px; padding: 4px 8px; border-radius: 4px; font-weight: bold; text-decoration: none; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn { border: none; padding: 12px 25px; border-radius: 25px; font-weight: bold; cursor: pointer; transition: 0.3s; text-decoration: none; text-align: center; }
        .btn-main { background: var(--neon); color: black; width: 250px; font-size: 18px; margin-top: 15px; }
        .btn-wa { background: #25D366; color: white; font-size: 12px; margin: 5px; }

        #hud { position: fixed; top: 10px; width: 100%; display: none; justify-content: center; gap: 8px; z-index: 100; pointer-events: none; }
        .stat { background: rgba(0,0,0,0.8); border: 1px solid var(--neon); padding: 5px 12px; border-radius: 10px; font-size: 12px; }
    </style>
</head>
<body>

    <div id="auth-screen" class="overlay-screen">
        <h1 style="color: var(--neon); text-shadow: 0 0 15px var(--neon);">NINJA NEON PRO</h1>
        <p style="font-size: 10px; opacity: 0.6;">CLOUD SECURE VERSION</p>
        <input type="email" id="email" class="input-box" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="tel" id="phone" class="input-box" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„">
        <button id="login-btn" class="btn btn-main" onclick="handleAuth()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ğŸ›¡ï¸</button>
        
        <div class="partners">
            <a href="https://gemini.google.com" target="_blank"><img src="https://www.gstatic.com/lamda/images/favicon_v1_150160d13988654cbfd0.svg" width="25"></a>
            <a href="https://github.com" target="_blank"><img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" width="25" style="filter:invert(1)"></a>
            <a href="https://supabase.com" target="_blank"><img src="https://seeklogo.com/images/S/supabase-logo-DCC4167731-seeklogo.com.png" width="25"></a>
            <a href="https://www.orange.eg/ar/orange-cash" target="_blank" class="orange-cash">ORANGE CASH</a>
        </div>
    </div>

    <div id="shop-screen" class="overlay-screen" style="display:none;">
        <h2 style="color: var(--neon);">Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„ØªØ¨Ø§Ø¯Ù„</h2>
        <div class="wallet-bar">
            <span>ğŸ’µ <span id="w-cash">0</span></span>
            <span>ğŸª™ <span id="w-coins">0</span></span>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn" style="background:#333; color:white; font-size:10px;" onclick="exchange('c2g')">100 ğŸª™ â” 2 ğŸ’µ</button>
            <button class="btn" style="background:var(--cash); color:white; font-size:10px;" onclick="exchange('g2c')">2 ğŸ’µ â” 100 ğŸª™</button>
        </div>
        <div id="skin-grid" class="shop-grid"></div>
        <button class="btn btn-main" onclick="startGame()">Ø§Ù†Ø·Ù„Ø§Ù‚ ğŸš€</button>
        <div style="margin-top:15px;">
            <button class="btn btn-wa" onclick="contactWA('ØªÙØ¹ÙŠÙ„ VIP')">ğŸ’ VIP</button>
            <button class="btn btn-wa" style="background:#444" onclick="contactWA('ØµØ±Ø§ÙØ©')">ğŸ’° Ø¨ÙŠØ¹/Ø´Ø±Ø§Ø¡</button>
        </div>
    </div>

    <div id="hud">
        <div class="stat">ğŸŒ€ LVL: <span id="h-lvl">1</span></div>
        <div class="stat">ğŸ’µ <span id="h-cash">0</span></div>
        <div class="stat">ğŸª™ <span id="h-coins">0</span></div>
        <div class="stat">â¤ï¸ <span id="h-lives">5</span></div>
    </div>

    <canvas id="g"></canvas>

<script>
    // [0] Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase
    const SB_URL = "https://ctnuuvdakmqpbuzhrsos.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0bnV1dmRha21xcGJ1emhyc29zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1ODczMzIsImV4cCI6MjA4NzE2MzMzMn0.0X_W6fnko1HezciPTISwnNCNxBUwps-QlAwxqIv3NRw";
    const supabase = supabase.createClient(SB_URL, SB_KEY);

    const SKINS = [
        {e:'ğŸ¥·', p:0, t:'free'}, {e:'ğŸ‘®', p:0, t:'free'},
        {e:'ğŸ¶', p:100, t:'coin'}, {e:'ğŸ±', p:200, t:'coin'}, {e:'ğŸ¼', p:300, t:'coin'}, {e:'ğŸ»â€â„ï¸', p:400, t:'coin'}, {e:'ğŸ¯', p:500, t:'coin'},
        {e:'ğŸ¦“', p:10, t:'cash'}, {e:'ğŸ¦™', p:20, t:'cash'}, {e:'ğŸ‘', p:30, t:'cash'}, {e:'ğŸ¦ƒ', p:40, t:'cash'}, {e:'ğŸ“', p:50, t:'cash'}, 
        {e:'ğŸ¦©', p:60, t:'cash'}, {e:'ğŸ¦œ', p:70, t:'cash'}, {e:'ğŸ¦š', p:80, t:'cash'}, {e:'ğŸ¦¤', p:90, t:'cash'},
        {e:'ğŸ¤¹â€â™‚ï¸', p:200, t:'vip'}, {e:'ğŸ¤¹â€â™€ï¸', p:300, t:'vip'}, {e:'ğŸ¥Š', p:400, t:'vip'}, {e:'ğŸ†', p:1000, t:'vip'}
    ];

    let user = { email:'', phone:'', cash:0, coins:0, owned:['ğŸ¥·','ğŸ‘®'], current:'ğŸ¥·', level:1 };
    let gameActive = false, portalActive = false, isSucking = false, pScale = 1;
    let monsters = [], items = [], projectiles = [], pX, pY, targetX, targetY, lastFire = 0, flash = 0;

    // [1] Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ
    async function handleAuth() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('phone').value;
        if(!e.includes('@') || p.length < 8) return alert("Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©");

        document.getElementById('login-btn').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...";
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase
        let { data, error } = await supabase.from('players').select('*').eq('email', e).single();

        if (data) {
            user = data; // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        } else {
            // Ù„Ø§Ø¹Ø¨ Ø¬Ø¯ÙŠØ¯: Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„
            user.email = e; user.phone = p;
            await supabase.from('players').insert([user]);
        }

        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('shop-screen').style.display = 'flex';
        renderShop();
    }

    async function save() {
        localStorage.setItem('ninjaUser', JSON.stringify(user));
        // Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ø­Ø§Ø¨ÙŠØ© Ù‡Ø§Ø¯Ø¦Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
        await supabase.from('players').upsert(user).eq('email', user.email);
    }

    // [2] Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ¬Ø±
    function renderShop() {
        document.getElementById('w-cash').innerText = user.cash;
        document.getElementById('w-coins').innerText = user.coins;
        const grid = document.getElementById('skin-grid'); grid.innerHTML = '';
        SKINS.forEach(s => {
            const isOwned = user.owned.includes(s.e);
            const card = document.createElement('div');
            card.className = `skin-item ${user.current===s.e?'selected':''}`;
            card.innerHTML = `<span style="font-size:30px; display:block;">${s.e}</span><span style="font-size:9px; color:var(--gold)">${isOwned?'ØªÙ…Ù„Ùƒ':s.p+(s.t==='coin'?' ğŸª™':' ğŸ’µ')}</span>`;
            card.onclick = () => {
                if(isOwned) user.current = s.e;
                else if(s.t==='coin' && user.coins >= s.p) { user.coins -= s.p; user.owned.push(s.e); user.current = s.e; }
                else if(s.t==='cash' && user.cash >= s.p) { user.cash -= s.p; user.owned.push(s.e); user.current = s.e; }
                else if(s.t==='vip') alert("ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ VIP");
                else alert("Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ!");
                save(); renderShop();
            };
            grid.appendChild(card);
        });
    }

    function exchange(m) {
        if(m==='c2g' && user.coins >= 100) { user.coins -= 100; user.cash += 2; }
        else if(m==='g2c' && user.cash >= 2) { user.cash -= 2; user.coins += 100; }
        save(); renderShop();
    }

    // [3] Ù…Ø­Ø±Ùƒ Ø§Ù„Ù„Ø¹Ø¨Ø©
    function startGame() {
        document.getElementById('shop-screen').style.display = 'none';
        document.getElementById('hud').style.display = 'flex';
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        pX = targetX = canvas.width/2; pY = targetY = canvas.height/2;
        gameActive = true; loop();
    }

    function loop() {
        if(!gameActive) return;
        ctx.fillStyle = "#050508"; ctx.fillRect(0, 0, canvas.width, canvas.height);

        if(!isSucking) {
            updateProjectiles();
            updateMonsters();
            updateItems();
            if(Math.random() < 0.01 + (user.level*0.005)) spawnMonster();
        }

        if (user.cash >= (2000 * user.level) && !portalActive) portalActive = true;
        
        if(portalActive) {
            drawPortal();
            if(Math.hypot(pX - canvas.width/2, pY - 150) < 60) {
                isSucking = true;
                if(pScale > 0) pScale -= 0.02;
                else { flash = 1; user.level++; user.cash=0; portalActive=false; isSucking=false; pScale=1; monsters=[]; save(); }
            }
        }

        pX += (targetX - pX) * 0.15; pY += (targetY - pY) * 0.15;
        drawPlayer();
        if(flash > 0) { ctx.fillStyle=`rgba(255,255,255,${flash})`; ctx.fillRect(0,0,canvas.width,canvas.height); flash -= 0.04; }
        updateHUD();
        requestAnimationFrame(loop);
    }

    function drawPlayer() {
        ctx.save(); ctx.translate(pX, pY); ctx.scale(pScale, pScale);
        ctx.shadowBlur = 15; ctx.shadowColor = "#00f2ff";
        ctx.font = "45px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillText(user.current, 0, 0); ctx.restore();
    }

    function spawnMonster() {
        const side = Math.floor(Math.random()*4);
        let x, y;
        if(side===0) { x=Math.random()*canvas.width; y=-50; }
        else if(side===1) { x=canvas.width+50; y=Math.random()*canvas.height; }
        else if(side===2) { x=Math.random()*canvas.width; y=canvas.height+50; }
        else { x=-50; y=Math.random()*canvas.height; }
        monsters.push({x, y, e: ['ğŸ‰','ğŸ¦–','ğŸ¦‚','ğŸ¦‘'][Math.floor(Math.random()*4)], s: 1.2 + user.level*0.2});
    }

    function updateMonsters() {
        monsters.forEach((m, i) => {
            let a = Math.atan2(pY - m.y, pX - m.x);
            m.x += Math.cos(a)*m.s; m.y += Math.sin(a)*m.s;
            ctx.font = "30px Arial"; ctx.fillText(m.e, m.x-15, m.y+15);
            projectiles.forEach((p, pi) => {
                if(Math.hypot(p.x - m.x, p.y - m.y) < 35) {
                    items.push({x: m.x, y: m.y, t: 'cash'});
                    monsters.splice(i, 1); projectiles.splice(pi, 1);
                }
            });
        });
    }

    function updateProjectiles() {
        let now = Date.now();
        if(now - lastFire > 160) {
            let a = Math.atan2(targetY - pY, targetX - pX);
            projectiles.push({x: pX, y: pY, vx: Math.cos(a)*18, vy: Math.sin(a)*18});
            lastFire = now;
        }
        projectiles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy;
            ctx.fillStyle = "#00f2ff";
            ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, 7); ctx.fill();
            if(p.x<0 || p.x>canvas.width || p.y<0 || p.y>canvas.height) projectiles.splice(i,1);
        });
    }

    function updateItems() {
        items.forEach((it, i) => {
            let a = Math.atan2(pY - it.y, pX - it.x);
            it.x += Math.cos(a)*12; it.y += Math.sin(a)*12;
            ctx.font = "20px Arial"; ctx.fillText("ğŸ’µ", it.x-10, it.y+10);
            if(Math.hypot(pX-it.x, pY-it.y)<30) { user.cash += 100; items.splice(i, 1); save(); }
        });
    }

    function drawPortal() {
        const cx = canvas.width/2, cy = 150, t = Date.now()*0.003;
        ctx.save(); ctx.strokeStyle = "#00f2ff"; ctx.lineWidth = 2;
        for(let i=0; i<3; i++){
            ctx.beginPath(); let o = i*2.1;
            for(let a=0; a<6.3; a+=0.2){
                let x = cx + Math.cos(a)*80*Math.cos(t+o) - Math.sin(a)*30*Math.sin(t+o);
                let y = cy + Math.cos(a)*80*Math.sin(t+o) + Math.sin(a)*30*Math.cos(t+o);
                a===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
            }
            ctx.stroke();
        } ctx.restore();
    }

    function contactWA(m) { window.open(`https://wa.me/201287837118?text=${encodeURIComponent(m + " | Ø§Ù„Ø­Ø³Ø§Ø¨: " + user.email)}`, '_blank'); }
    function updateHUD() {
        document.getElementById('h-cash').innerText = user.cash;
        document.getElementById('h-coins').innerText = user.coins;
        document.getElementById('h-lvl').innerText = user.level;
    }

    window.addEventListener('pointermove', e => { targetX = e.clientX; targetY = e.clientY; });

    // [PWA Service Worker]
    if ('serviceWorker' in navigator) {
        const sw = `const cacheName = 'ninja-v2'; self.addEventListener('install', e => e.waitUntil(caches.open(cacheName).then(c => c.addAll(['./'])))); self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));`;
        const blob = new Blob([sw], {type: 'text/javascript'});
        navigator.serviceWorker.register(URL.createObjectURL(blob));
    }
</script>
</body>
</html>
