<!DOCTYPE html>
<html lang="ar">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BLOCKSAM v1.1 - ULTIMATE</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
    <style>
        :root { 
            --neon: #00f2ff; --gold: #ffd700; --green: #2ecc71; --red: #ff4757; 
            --purple: #bc13fe; --bg: #0f101d; --ui-bg: rgba(20, 21, 38, 0.95);
        }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Segoe UI', sans-serif; touch-action: none; color: white; display: flex; flex-direction: column; }
        
        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
        #ui-header { width: 100%; height: 85px; background: var(--ui-bg); display: none; justify-content: space-between; align-items: center; z-index: 1000; border-bottom: 1px solid #334; padding: 5px 15px 0 15px; box-sizing: border-box; }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ù…ÙØªÙˆØ­Ø© (Ø¨Ø¯ÙˆÙ† Ø­Ø¯ÙˆØ¯) */
        #gameCanvas { flex-grow: 1; width: 100%; background: radial-gradient(circle, #1a1c2c 0%, #0f101d 100%); display: block; cursor: none; }

        .stat-group { display: flex; flex-direction: column; gap: 2px; min-width: 90px; }
        .controls-group { display: flex; gap: 10px; align-items: center; }
        .nav-btn { background: none; border: 1.5px solid white; color: white; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .overlay { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 6000; background: rgba(10, 11, 20, 0.98); }
        .menu-box { background: #1a1c2c; padding: 25px; border-radius: 30px; border: 1px solid var(--neon); text-align: center; width: 85%; max-width: 400px; box-shadow: 0 0 30px rgba(0, 242, 255, 0.15); }
        .btn { width: 100%; padding: 14px; margin: 8px 0; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; color: white; background: #3d415e; transition: 0.2s; font-size: 14px; }
        .btn:active { transform: scale(0.95); }
        .shop-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-height: 250px; overflow-y: auto; margin: 15px 0; padding: 10px; background: #0f101d; border-radius: 15px; }
        .skin-item { background: #3d415e; height: 80px; border-radius: 12px; border: 1px solid #555; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 24px; }
        .price-tag { font-size: 10px; margin-top: 6px; font-weight: bold; }
        .wa-btn { background: #25D366; color: white; text-decoration: none; padding: 12px; border-radius: 12px; display: block; margin: 10px 0; font-weight: bold; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="notify" style="position:fixed; top:100px; left:50%; transform:translateX(-50%); z-index:9000; display:none; padding:10px 20px; border-radius:20px; font-weight:bold; color:white; text-shadow: 0 1px 3px black;"></div>

    <div id="loading-screen" class="overlay">
        <div style="border:4px solid var(--neon); border-top:4px solid transparent; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite;"></div>
        <h2 style="margin-top:20px;">SAM CLOUD CONNECTING...</h2>
    </div>

    <div id="main-menu" class="overlay" style="display:none">
        <h1 style="color:var(--neon); margin-bottom:20px; text-shadow: 0 0 10px var(--neon);">BLOCKSAM v1.1</h1>
        <div class="menu-box">
            <button class="btn" style="background:var(--gold); color:black" onclick="startMode('solo')">SOLO MISSION ğŸ†</button>
            <button class="btn" style="background:var(--neon); color:black" onclick="searchForPlayer()">SEARCH FOR PLAYER ğŸŒ</button>
            <button class="btn" onclick="openShop()">MARKET ğŸ›’</button>
            <button id="install-btn" class="btn" style="display:none; background:white; color:black;">INSTALL APP ğŸ“²</button>
        </div>
    </div>

    <div id="shop-screen" class="overlay" style="display:none">
        <div class="menu-box">
            <h3 style="color:var(--purple); margin:0;">EXCHANGE</h3>
            <button class="btn" style="background:var(--gold); color:black; font-size:11px" onclick="exchangeCoinsForCash()">50,000 ğŸ’° â” 10 ğŸ’µ</button>
            <div id="shop-grid" class="shop-grid"></div>
            <a href="https://wa.me/201287837118" target="_blank" class="wa-btn">RECHARGE CASH ğŸ’¬</a>
            <button class="btn" onclick="closeShop()">BACK</button>
        </div>
    </div>

    <div id="ui-header">
        <div class="stat-group">
            <div><span id="p1-score-ui" style="color:var(--gold)">0</span> ğŸ’°</div>
            <div><span id="p1-cash-ui" style="color:var(--green)">0</span> ğŸ’µ</div>
        </div>
        <div class="controls-group">
            <button class="nav-btn" onclick="togglePause()">â¸ï¸</button>
            <button class="nav-btn" onclick="exitToDashboard()" style="border-color:var(--red)">ğŸ </button>
        </div>
        <div id="p2-ui" class="stat-group" style="text-align: right; opacity: 0;">
            <div style="font-size:9px; color:#aaa;">OPPONENT</div>
            <div>ğŸ’° <span id="p2-score-ui">0</span></div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    const { Client, Account, Databases, ID, Query } = Appwrite;
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
    let gates = [], items = [];
    let spiralAngle = 0;
    let game = { active: false, paused: false };
    let p1 = { x: 200, y: 300, tx: 200, ty: 300, score: 0, cash: 0, icon: 'ğŸ¥·' };
    let p2 = { x: -100, y: -100, score: 0, active: false, icon: 'ğŸ¤–', isBot: true };
    let monster = { x: 0, y: 0, icon: 'ğŸ‘¾', active: true, speed: 1.5 };

    const client = new Client().setEndpoint('https://fra.cloud.appwrite.io/v1').setProject('69943f560019334ae3b5');
    const databases = new Databases(client);
    const account = new Account(client);
    const DB_ID = '69943bf8001373c3c286', COL_ID = 'players';
    let playerDocId = localStorage.getItem('blocksam_id');

    const skinsData = [
        {icon:'ğŸ¥·', price:0, type:'coin'}, {icon:'ğŸ±', price:0, type:'coin'}, {icon:'ğŸ¦', price:5000, type:'coin'},
        {icon:'ğŸ¦–', price:60000, type:'coin'}, {icon:'ğŸ‘½', price:5, type:'cash'}, {icon:'ğŸ’', price:250, type:'cash'}
    ];

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight - (document.getElementById('ui-header').offsetHeight || 85);
    }
    window.addEventListener('resize', resize);

    async function initCloud() {
        try {
            try { await account.createAnonymousSession(); } catch(e){}
            if (playerDocId) {
                const doc = await databases.getDocument(DB_ID, COL_ID, playerDocId);
                p1.score = doc.coins; p1.cash = doc.cash; p1.icon = doc.current_skin;
                updateUI();
            } else { await createNewUser(); }
        } catch(e){}
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('main-menu').style.display = 'flex';
        resize();
    }

    async function createNewUser() {
        const d = await databases.createDocument(DB_ID, COL_ID, ID.unique(), { coins: 0, cash: 0, current_skin: 'ğŸ¥·', is_online: false });
        playerDocId = d.$id; localStorage.setItem('blocksam_id', playerDocId);
    }

    async function sync() {
        if(!playerDocId) return;
        try { await databases.updateDocument(DB_ID, COL_ID, playerDocId, { coins: p1.score, cash: p1.cash, current_skin: p1.icon }); } catch(e){}
    }

    function updateUI() {
        document.getElementById('p1-score-ui').innerText = p1.score.toLocaleString();
        document.getElementById('p1-cash-ui').innerText = p1.cash;
    }

    function startMode(mode) {
        game.active = true; game.paused = false;
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('ui-header').style.display = 'flex';
        resize();
        monster.x = -50; monster.y = -50;
        if (mode === 'solo') {
            p2.active = false; 
            document.getElementById('p2-ui').style.opacity = '0';
        } else {
            p2.active = true; 
            document.getElementById('p2-ui').style.opacity = '1';
        }
        animate();
    }

    function animate() {
        if (!game.active || game.paused) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        spiralAngle += 0.15;

        // Ø±Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨
        p1.x += (p1.tx - p1.x) * 0.15; p1.y += (p1.ty - p1.y) * 0.15;
        ctx.font = "50px serif"; ctx.textAlign = "center";
        ctx.fillText(p1.icon, p1.x, p1.y);

        // Ø§Ù„ÙˆØ­Ø´ Ø§Ù„Ù…Ø·Ø§Ø±Ø¯ (ğŸ‘¾) - Ø¯Ø§Ø¦Ù… Ø§Ù„ØªÙˆØ§Ø¬Ø¯
        let mAngle = Math.atan2(p1.y - monster.y, p1.x - monster.x);
        monster.x += Math.cos(mAngle) * (1.6 + (p1.score/100000));
        monster.y += Math.sin(mAngle) * (1.6 + (p1.score/100000));
        ctx.fillText(monster.icon, monster.x, monster.y);
        if(Math.hypot(p1.x - monster.x, p1.y - monster.y) < 40) {
            p1.score = Math.max(0, p1.score - 100);
            showMsg("WATCH OUT! ğŸ‘¾", "var(--red)");
            updateUI();
        }

        // Ø§Ù„Ø¨ÙˆØ§Ø¨Ø§Øª Ø§Ù„Ø­Ù„Ø²ÙˆÙ†ÙŠØ© (Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©)
        gates.forEach((g) => {
            if(!g.active) return;
            g.timer++;
            if(g.timer > 200) { 
                g.x = Math.random() * (canvas.width - 60) + 30;
                g.y = Math.random() * (canvas.height - 60) + 30;
                g.timer = 0;
            }
            ctx.save(); ctx.translate(g.x, g.y); ctx.rotate(spiralAngle);
            for(let i=0; i<5; i++) {
                ctx.beginPath(); ctx.strokeStyle = g.type==='good'?'var(--neon)':'var(--red)';
                ctx.lineWidth = 2; ctx.arc(0, 0, (11*(i+1)), 0, Math.PI*1.5); ctx.stroke();
            }
            ctx.restore();
            if(Math.hypot(p1.x-g.x, p1.y-g.y) < 45) {
                p1.score += g.value; if(p1.score < 0) p1.score = 0;
                g.active = false;
                showMsg(g.value > 0 ? "EXCELLENT! ğŸŒ€" : "Ouch! âš ï¸", g.type==='good'?'var(--green)':'var(--red)');
                sync(); updateUI();
            }
        });

        // Ø§Ù„Ø¨ÙˆØª (ÙÙŠ Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ÙÙ‚Ø·)
        if (p2.active) {
            let target = items.find(it => it.active);
            if (target) {
                let p2Angle = Math.atan2(target.y - p2.y, target.x - p2.x);
                p2.x += Math.cos(p2Angle) * 2.3; p2.y += Math.sin(p2Angle) * 2.3;
                if(Math.hypot(p2.x-target.x, p2.y-target.y) < 30) { target.active = false; p2.score += 500; }
            }
            ctx.fillText(p2.icon, p2.x, p2.y);
            document.getElementById('p2-score-ui').innerText = p2.score;
        }

        // Ø§Ù„Ø¹Ù…Ù„Ø§Øª
        items.forEach(it => {
            if(!it.active) return;
            ctx.font = "32px serif"; ctx.fillText(it.type==='cash'?"ğŸ’µ":"ğŸ’°", it.x, it.y);
            if(Math.hypot(p1.x-it.x, p1.y-it.y) < 45) { 
                it.active = false; 
                if(it.type==='cash') p1.cash++; else p1.score += 500; 
                sync(); updateUI();
            }
        });

        requestAnimationFrame(animate);
    }

    function showMsg(t, c) { const n = document.getElementById('notify'); n.innerText = t; n.style.background = c; n.style.display = 'block'; setTimeout(()=>n.style.display='none', 1500); }
    function togglePause() { game.paused = !game.paused; if(!game.paused) animate(); }
    function exitToDashboard() { game.active = false; document.getElementById('ui-header').style.display='none'; document.getElementById('main-menu').style.display='flex'; }
    function openShop() { document.getElementById('shop-screen').style.display='flex'; /* ÙƒÙˆØ¯ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø´Ø¨ÙƒØ© */ }
    function closeShop() { document.getElementById('shop-screen').style.display='none'; }

    canvas.addEventListener('touchmove', (e) => { 
        if(!game.paused) { p1.tx = e.touches[0].clientX; p1.ty = e.touches[0].clientY - 85; } 
    });

    setInterval(() => { if(game.active && !game.paused) items.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, type: Math.random()<0.08?'cash':'coin', active: true }); }, 1900);
    setInterval(() => { 
        if(game.active && !game.paused) {
            const isGood = Math.random() > 0.4;
            gates.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, type: isGood?'good':'bad', value: isGood?5000:-3000, active: true, timer: 0 });
            if(gates.length > 4) gates.shift();
        }
    }, 6000);

    initCloud();
</script>
</body>
    </html>
