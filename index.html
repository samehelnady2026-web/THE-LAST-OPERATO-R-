<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE LAST OPERATOR | FINAL CLOUD</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --neon: #00f2ff; --bg: #050508; }
        body, html { margin: 0; padding: 0; overflow: hidden; background: var(--bg); font-family: sans-serif; color: white; touch-action: none; }
        canvas { display: block; }
        .screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .input-box { background: #111; border: 1.5px solid var(--neon); padding: 12px; border-radius: 12px; color: white; width: 260px; margin: 8px; text-align: center; outline: none; }
        .btn { padding: 12px 25px; border-radius: 25px; border: none; font-weight: bold; cursor: pointer; background: var(--neon); color: black; width: 250px; margin: 10px; transition: 0.3s; }
        .btn:disabled { background: #444; color: #888; cursor: not-allowed; }
        #hud { position: fixed; top: 10px; width: 100%; display: none; justify-content: center; gap: 8px; z-index: 100; pointer-events: none; }
        .stat { background: rgba(0,0,0,0.85); border: 1px solid var(--neon); padding: 6px 14px; border-radius: 12px; font-size: 13px; display: flex; align-items: center; gap: 5px; }
    </style>
</head>
<body>

    <div id="auth-screen" class="screen">
        <h1 style="color: var(--neon); text-shadow: 0 0 15px var(--neon);">THE LAST OPERATOR</h1>
        <input type="email" id="email" class="input-box" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input type="tel" id="phone" class="input-box" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±)">
        <button id="auth-btn" class="btn" onclick="handleAuth()">ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ âš¡</button>
        <p id="msg" style="font-size: 12px; color: #aaa; margin-top: 10px;"></p>
    </div>

    <div id="hud">
        <div class="stat">â¤ï¸ <span id="h-lives">5</span></div>
        <div class="stat">ğŸª™ <span id="h-coins">0</span></div>
        <div class="stat">ğŸ’µ <span id="h-cash">0</span></div>
        <div class="stat">ğŸŒ€ LVL: <span id="h-lvl">1</span></div>
    </div>

    <canvas id="g"></canvas>

<script>
    const SB_URL = "https://ctnuuvdakmqpbuzhrsos.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0bnV1dmRha21xcGJ1emhyc29zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1ODczMzIsImV4cCI6MjA4NzE2MzMzMn0.0X_W6fnko1HezciPTISwnNCNxBUwps-QlAwxqIv3NRw";
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    let user = { email: '', phone: '', cash: 0, coins: 0, owned: ['ğŸ¥·'], current: 'ğŸ¥·', level: 1, lives: 5 };
    let gameActive = false, pX, pY, targetX, targetY, monsters = [], projectiles = [], items = [];

    async function handleAuth() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('phone').value;
        const btn = document.getElementById('auth-btn');
        const msg = document.getElementById('msg');

        if(!e || !p) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");
        btn.disabled = true; btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...";

        // 1. Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        const { data: signInData, error: signInError } = await supabaseClient.auth.signInWithPassword({ email: e, password: p });

        if (signInError) {
            // 2. Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯)ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªØ³Ø¬ÙŠÙ„
            const { error: signUpError } = await supabaseClient.auth.signUp({ email: e, password: p });
            
            if (signUpError) {
                alert("Ø®Ø·Ø£: " + signUpError.message);
                btn.disabled = false; btn.innerText = "ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ âš¡";
                return;
            }
            msg.innerText = "ğŸ“§ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· ØªÙØ¹ÙŠÙ„! Ø§ÙØ­Øµ Ø¨Ø±ÙŠØ¯Ùƒ (ÙˆØ§Ù„Ù€ Spam) Ù„ØªØ¸Ù‡Ø± Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‡Ù†Ø§.";
            btn.disabled = false; btn.innerText = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„...";
            return;
        }

        // 3. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¯Ø®ÙˆÙ„
        let { data: playerData } = await supabaseClient.from('players').select('*').eq('email', e).single();

        if (!playerData) {
            await supabaseClient.from('players').insert([{ email: e, phone: p, cash: 0, coins: 0, level: 1, owned: ['ğŸ¥·'], current: 'ğŸ¥·' }]);
            user.email = e; user.phone = p;
        } else {
            user = { ...user, ...playerData, lives: 5 };
        }

        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('hud').style.display = 'flex';
        startGame();
    }

    function startGame() {
        const canvas = document.getElementById('g');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        pX = targetX = canvas.width/2; pY = targetY = canvas.height/2;
        gameActive = true; loop();
    }

    function explodeMonster(mX, mY) {
        for (let i = 0; i < 10; i++) {
            items.push({
                x: mX, y: mY, t: 'coin',
                vx: (Math.random() - 0.5) * 12, vy: (Math.random() - 0.5) * 12, life: 60
            });
        }
        if(Math.random() < 0.1) items.push({ x: mX, y: mY, t: 'cash', vx: (Math.random()-0.5)*6, vy: (Math.random()-0.5)*6, life: 60 });
    }

    function loop() {
        if(!gameActive) return;
        const canvas = document.getElementById('g'), ctx = canvas.getContext('2d');
        ctx.fillStyle = "#050508"; ctx.fillRect(0, 0, canvas.width, canvas.height);

        pX += (targetX - pX) * 0.12; pY += (targetY - pY) * 0.12;
        ctx.font = "45px Arial"; ctx.textAlign = "center"; ctx.fillText(user.current, pX, pY);

        if(Math.random() < 0.02) monsters.push({ x: Math.random()*canvas.width, y: -50, e: Math.random()>0.5?'ğŸ¦‚':'ğŸ‰', s: 2 + (user.level*0.1) });

        monsters.forEach((m, i) => {
            let a = Math.atan2(pY - m.y, pX - m.x);
            m.x += Math.cos(a)*m.s; m.y += Math.sin(a)*m.s;
            ctx.fillText(m.e, m.x, m.y);
            projectiles.forEach((p, pi) => {
                if(Math.hypot(p.x-m.x, p.y-m.y) < 30) {
                    explodeMonster(m.x, m.y); monsters.splice(i, 1); projectiles.splice(pi, 1);
                }
            });
            if(Math.hypot(pX-m.x, pY-m.y) < 25) { user.lives--; monsters.splice(i, 1); if(user.lives<=0) location.reload(); }
        });

        items.forEach((it, i) => {
            if(it.life > 0) {
                it.x += it.vx; it.y += it.vy; it.vx *= 0.95; it.vy *= 0.95; it.life--;
            } else {
                let a = Math.atan2(pY - it.y, pX - it.x);
                it.x += Math.cos(a)*12; it.y += Math.sin(a)*12;
            }
            ctx.font = "20px Arial"; ctx.fillText(it.t==='coin'?'ğŸª™':'ğŸ’µ', it.x, it.y);
            if(Math.hypot(pX-it.x, pY-it.y) < 25) { it.t==='coin' ? user.coins++ : user.cash++; items.splice(i, 1); }
        });

        if(Date.now() % 15 === 0) {
            let a = Math.atan2(targetY - pY, targetX - pX);
            projectiles.push({ x: pX, y: pY, vx: Math.cos(a)*16, vy: Math.sin(a)*16 });
        }
        projectiles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; ctx.fillStyle="#00f2ff"; ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, 7); ctx.fill();
            if(p.x<0 || p.x>canvas.width || p.y<0 || p.y>canvas.height) projectiles.splice(i, 1);
        });

        document.getElementById('h-coins').innerText = user.coins;
        document.getElementById('h-cash').innerText = user.cash;
        document.getElementById('h-lvl').innerText = user.level;
        document.getElementById('h-lives').innerText = user.lives;

        requestAnimationFrame(loop);
    }

    window.addEventListener('pointermove', e => { targetX = e.clientX; targetY = e.clientY; });
    setInterval(async () => { if(gameActive) await supabaseClient.from('players').upsert(user).eq('email', user.email); }, 5000);
</script>
</body>
</html>
