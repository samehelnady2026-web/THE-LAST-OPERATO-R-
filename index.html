<!DOCTYPE html>
<html lang="ar">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BLOCKSAM v1.1 - MEGA MARKET</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
    <style>
        :root { --neon: #00f2ff; --gold: #ffd700; --green: #2ecc71; --red: #ff4757; --purple: #bc13fe; --bg: #0a0a0a; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: sans-serif; touch-action: none; color: white; }
        
        /* ÿßŸÑŸàÿßÿ¨Ÿáÿ© ÿßŸÑÿπŸÑŸàŸäÿ© */
        #ui-header { position: absolute; top: 0; width: 100%; height: 85px; background: rgba(0,0,0,0.95); display: none; justify-content: space-between; align-items: center; z-index: 1000; border-bottom: 2px solid #333; padding: 5px 15px 0 15px; box-sizing: border-box; }
        .stat-group { display: flex; flex-direction: column; gap: 2px; min-width: 90px; }
        .controls-group { display: flex; gap: 10px; align-items: center; }
        .nav-btn { background: none; border: 1.5px solid white; color: white; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }

        /* ÿßŸÑŸÇŸàÿßÿ¶ŸÖ */
        .overlay { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 6000; background: rgba(0,0,0,0.96); }
        .menu-box { background: #151515; padding: 20px; border-radius: 30px; border: 1px solid var(--neon); text-align: center; width: 90%; max-width: 400px; }
        .btn { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; color: white; background: #333; transition: 0.2s; }
        
        /* ÿßŸÑŸÖÿ™ÿ¨ÿ± */
        .shop-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-height: 250px; overflow-y: auto; margin: 10px 0; padding: 10px; background: #111; border-radius: 15px; }
        .skin-item { background: #222; height: 80px; border-radius: 12px; border: 1px solid #444; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; }
        .price-tag { font-size: 9px; margin-top: 6px; font-weight: bold; }

        .wa-btn { background: #25D366; color: white; text-decoration: none; padding: 12px; border-radius: 12px; display: block; margin-top: 10px; font-weight: bold; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="notify" style="position:fixed; top:100px; left:50%; transform:translateX(-50%); z-index:9000; display:none; padding:10px 20px; border-radius:20px;"></div>

    <div id="loading-screen" class="overlay"><h2>CONNECTING TO SAM CLOUD...</h2></div>

    <div id="main-menu" class="overlay" style="display:none">
        <h1 style="color:var(--neon); margin-bottom:20px;">BLOCKSAM v1.1</h1>
        <div class="menu-box">
            <button class="btn" style="background:var(--gold); color:black" onclick="startMode('solo')">SOLO MISSION</button>
            <button class="btn" style="background:var(--neon); color:black" onclick="searchForPlayer()">SEARCH FOR PLAYER üåê</button>
            <button class="btn" onclick="openShop()">MARKET üõí</button>
            <button id="install-btn" class="btn" style="display:none; background:white; color:black;">INSTALL APP üì≤</button>
        </div>
    </div>

    <div id="shop-screen" class="overlay" style="display:none">
        <div class="menu-box">
            <h3 style="color:var(--purple); margin:0;">EXCHANGE & ITEMS</h3>
            <button class="btn" style="background:var(--gold); color:black; font-size:11px" onclick="exchangeCoinsForCash()">50,000 üí∞ ‚ûî 10 üíµ</button>
            <h3 style="color:var(--neon); margin:10px 0;">SKINS</h3>
            <div id="shop-grid" class="shop-grid"></div>
            <a href="https://wa.me/201287837118?text=ÿ£ŸÜÿß ÿπÿßŸàÿ≤ ÿ£ÿ¥ÿ≠ŸÜ ŸÉÿßÿ¥ ŸÅŸä ŸÑÿπÿ®ÿ© Blocksam" target="_blank" class="wa-btn">RECHARGE CASH üí¨</a>
            <button class="btn" onclick="closeShop()">BACK</button>
        </div>
    </div>

    <div id="ui-header">
        <div class="stat-group">
            <div class="stat-item"><span id="p1-score-ui" style="color:var(--gold)">0</span> üí∞</div>
            <div class="stat-item"><span id="p1-cash-ui" style="color:var(--green)">0</span> üíµ</div>
        </div>
        <div class="controls-group">
            <button class="nav-btn" onclick="togglePause()">‚è∏Ô∏è</button>
            <button class="nav-btn" onclick="exitToDashboard()" style="border-color:var(--red)">üè†</button>
        </div>
        <div id="p2-ui" class="stat-group" style="text-align: right; opacity: 0;">
            <div style="font-size:9px; color:#888;">OPPONENT</div>
            <div class="stat-item">üí∞ <span id="p2-score-ui">0</span></div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    const { Client, Account, Databases, ID, Query } = Appwrite;
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;

    const client = new Client().setEndpoint('https://fra.cloud.appwrite.io/v1').setProject('69943f560019334ae3b5');
    const databases = new Databases(client);
    const account = new Account(client);

    const DB_ID = '69943bf8001373c3c286', COL_ID = 'players';
    let playerDocId = localStorage.getItem('blocksam_id');
    let game = { active: false, paused: false };
    let p1 = { x: 200, y: 300, tx: 200, ty: 300, score: 0, cash: 0, icon: 'ü•∑' };
    let p2 = { x: -100, y: -100, score: 0, active: false, icon: 'ü§ñ', isBot: true };
    let items = [];

    const skinsData = [
        // --- 5 ÿ≥ŸÉŸÜÿßÿ™ ŸÖÿ¨ÿßŸÜŸäÿ© (Free) ---
        {icon:'ü•∑', price:0, type:'coin'},
        {icon:'üê±', price:0, type:'coin'},
        {icon:'üëÆ', price:0, type:'coin'},
        {icon:'üê≠', price:0, type:'coin'},
        {icon:'ü§ñ', price:0, type:'coin'},

        // --- 10 ÿ≥ŸÉŸÜÿßÿ™ ÿ®ÿßŸÑŸÉŸàŸäŸÜÿ≤ (ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ) ---
        {icon:'ü¶ä', price:2000, type:'coin'},
        {icon:'ü¶Å', price:5000, type:'coin'},
        {icon:'üêØ', price:10000, type:'coin'},
        {icon:'üêº', price:15000, type:'coin'},
        {icon:'ü¶ç', price:25000, type:'coin'},
        {icon:'üêò', price:40000, type:'coin'},
        {icon:'ü¶ñ', price:60000, type:'coin'},
        {icon:'üêä', price:85000, type:'coin'},
        {icon:'ü¶Ñ', price:120000, type:'coin'},
        {icon:'üêâ', price:200000, type:'coin'},

        // --- 10 ÿ≥ŸÉŸÜÿßÿ™ ÿ®ÿßŸÑŸÉÿßÿ¥ ŸÅŸÇÿ∑ (VIP) ---
        {icon:'üëΩ', price:5, type:'cash'},
        {icon:'üë∫', price:10, type:'cash'},
        {icon:'üßõ', price:15, type:'cash'},
        {icon:'ü§°', price:20, type:'cash'},
        {icon:'üëª', price:30, type:'cash'},
        {icon:'üíÄ', price:50, type:'cash'},
        {icon:'üòà', price:75, type:'cash'},
        {icon:'üëë', price:100, type:'cash'},
        {icon:'üíé', price:250, type:'cash'},
        {icon:'‚≠ê', price:500, type:'cash'}
    ];

    // --- ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÄ PWA ---
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault(); deferredPrompt = e;
        document.getElementById('install-btn').style.display = 'block';
    });

    document.getElementById('install-btn').onclick = async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') document.getElementById('install-btn').style.display = 'none';
        }
    };

    async function initCloud() {
        try {
            try { await account.createAnonymousSession(); } catch(e){}
            if (playerDocId) {
                const doc = await databases.getDocument(DB_ID, COL_ID, playerDocId);
                p1.score = doc.coins; p1.cash = doc.cash; p1.icon = doc.current_skin;
            } else { await createNewUser(); }
        } catch(e) {}
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('main-menu').style.display = 'flex';
    }

    async function createNewUser() {
        const d = await databases.createDocument(DB_ID, COL_ID, ID.unique(), { coins: 0, cash: 0, current_skin: 'ü•∑', is_online: false });
        playerDocId = d.$id; localStorage.setItem('blocksam_id', playerDocId);
    }

async function searchForPlayer() {
        document.getElementById('main-menu').style.display = 'none';
        const screen = document.createElement('div'); 
        screen.className = 'overlay';
        screen.id = "search-overlay";
        screen.innerHTML = `
            <div style="text-align:center">
                <div style="border:4px solid var(--neon); border-top:4px solid transparent; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:0 auto 15px"></div>
                <h3 id="search-status">SEARCHING FOR REAL PLAYER...</h3>
                <div id="timer-bar" style="width:100%; height:5px; background:#333; margin-top:10px; border-radius:5px; overflow:hidden">
                    <div id="progress" style="width:0%; height:100%; background:var(--neon); transition:1s linear"></div>
                </div>
            </div>`; 
        document.body.appendChild(screen);

        // 1. ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ™Ÿä ÿ£ŸàŸÜŸÑÿßŸäŸÜ ŸÅŸàÿ±ÿßŸã
        try {
            await databases.updateDocument(DB_ID, COL_ID, playerDocId, { is_online: true });
        } catch(e) { console.error("Cloud status error"); }

        let searchTime = 0;
        const maxWait = 5; // 5 ÿ´ŸàÿßŸÜŸä ÿßŸÜÿ™ÿ∏ÿßÿ±

        const searchTick = setInterval(async () => {
            searchTime++;
            document.getElementById('progress').style.width = (searchTime / maxWait * 100) + "%";

            try {
                // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÑÿßÿπÿ® ÿ≠ŸÇŸäŸÇŸä
                const res = await databases.listDocuments(DB_ID, COL_ID, [
                    Query.equal('is_online', true),
                    Query.notEqual('$id', playerDocId),
                    Query.limit(1)
                ]);

                if (res.documents.length > 0) {
                    clearInterval(searchTick);
                    const opponent = res.documents[0];
                    document.getElementById('search-status').innerText = "PLAYER FOUND!";
                    p2.icon = opponent.current_skin || 'üë∫';
                    p2.isBot = false;
                    setTimeout(() => { screen.remove(); startMode(); }, 1000);
                    return;
                }
            } catch(e) { console.log("Searching..."); }

            // 2. ŸÑŸà ŸÖŸÑŸÇÿßÿ¥ ÿ≠ÿØ ÿ®ÿπÿØ 5 ÿ´ŸàÿßŸÜŸä.. ÿ¥ÿ∫ŸÑ ÿßŸÑÿ®Ÿàÿ™ ŸÅŸàÿ±ÿßŸã
            if (searchTime >= maxWait) {
                clearInterval(searchTick);
                document.getElementById('search-status').innerText = "NO PLAYERS FOUND. BOT ACTIVE!";
                p2.icon = 'ü§ñ';
                p2.isBot = true;
                setTimeout(() => { screen.remove(); startMode(); }, 1000);
            }
        }, 1000);
    }

    function startMode() {
        game.active = true; game.paused = false;
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('ui-header').style.display = 'flex';
        p2.active = true; document.getElementById('p2-ui').style.opacity = '1';
        animate();
    }

    function exitToDashboard() {
        game.active = false;
        databases.updateDocument(DB_ID, COL_ID, playerDocId, { is_online: false });
        document.getElementById('ui-header').style.display = 'none';
        document.getElementById('main-menu').style.display = 'flex';
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function animate() {
        if (!game.active || game.paused) { requestAnimationFrame(animate); return; }
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ŸÑÿßÿπÿ® 1
        p1.x += (p1.tx - p1.x) * 0.15; p1.y += (p1.ty - p1.y) * 0.15;
        ctx.font = "50px serif"; ctx.textAlign = "center"; ctx.fillText(p1.icon, p1.x, p1.y);

        // ÿßŸÑÿÆÿµŸÖ (ÿ®Ÿàÿ™ ÿ£Ÿà ÿ≠ŸÇŸäŸÇŸä - ŸÖÿ≠ÿßŸÉÿßÿ© ÿ≠ÿ±ŸÉÿ©)
        if (p2.active) {
            let target = items.find(it => it.active);
            if (target) {
                let speed = p2.isBot ? 2 : 3.5;
                let angle = Math.atan2(target.y - p2.y, target.x - p2.x);
                p2.x += Math.cos(angle) * speed; p2.y += Math.sin(angle) * speed;
                if(Math.hypot(p2.x-target.x, p2.y-target.y) < 30) { target.active = false; p2.score += 500; }
            }
            ctx.fillText(p2.icon, p2.x, p2.y);
            document.getElementById('p2-score-ui').innerText = p2.score;
        }

        // ÿßŸÑÿπŸÜÿßÿµÿ±
        items.forEach(it => {
            if(!it.active) return;
            ctx.font = "30px serif"; ctx.fillText(it.type==='cash'?"üíµ":"üí∞", it.x, it.y);
            if(Math.hypot(p1.x-it.x, p1.y-it.y) < 40) { 
                it.active = false; 
                if(it.type==='cash') p1.cash++; else p1.score+=500; 
                sync(); 
            }
        });

        document.getElementById('p1-score-ui').innerText = p1.score;
        document.getElementById('p1-cash-ui').innerText = p1.cash;
        requestAnimationFrame(animate);
    }

    async function sync() {
        if(!playerDocId) return;
        try { await databases.updateDocument(DB_ID, COL_ID, playerDocId, { coins: p1.score, cash: p1.cash, current_skin: p1.icon }); } catch(e){}
    }

    function openShop() {
        document.getElementById('shop-screen').style.display = 'flex';
        const grid = document.getElementById('shop-grid'); grid.innerHTML = '';
        skinsData.forEach((s, i) => {
            const d = document.createElement('div'); d.className = 'skin-item';
            d.innerHTML = `<div>${s.icon}</div><div class="price-tag" style="color:${s.type==='coin'?'var(--gold)':'var(--green)'}">${s.price}</div>`;
            d.onclick = () => {
                if(s.type==='coin' && p1.score >= s.price) { p1.score-=s.price; p1.icon=s.icon; sync(); showMsg("SKIN UNLOCKED!", "green"); }
                else if(s.type==='cash' && p1.cash >= s.price) { p1.cash-=s.price; p1.icon=s.icon; sync(); showMsg("PREMIUM SKIN!", "purple"); }
                openShop();
            };
            grid.appendChild(d);
        });
    }

    function exchangeCoinsForCash() {
        if(p1.score >= 50000) { p1.score -= 50000; p1.cash += 10; sync(); showMsg("EXCHANGED!", "green"); }
        else showMsg("NEED 50,000 COINS!", "red");
    }

    function closeShop() { document.getElementById('shop-screen').style.display = 'none'; }
    function togglePause() { game.paused = !game.paused; }
    function showMsg(t, c) { const n = document.getElementById('notify'); n.innerText = t; n.style.background = c; n.style.display = 'block'; setTimeout(()=>n.style.display='none', 2000); }
    
    canvas.addEventListener('touchmove', (e) => { if(!game.paused) { p1.tx = e.touches[0].clientX; p1.ty = e.touches[0].clientY; } });
    setInterval(() => { if(game.active && !game.paused) items.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, type: Math.random()<0.08?'cash':'coin', active: true }); }, 2000);

    initCloud();
</script>
</body>
    </html>
