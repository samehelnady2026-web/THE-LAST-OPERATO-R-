<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BLOCKSAM v2.9 - MONSTER UPDATE</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
    <style>
        :root { --neon: #00f2ff; --gold: #ffd700; --green: #2ecc71; --red: #ff4757; --bg: #0a0a0a; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: sans-serif; touch-action: none; color: white; }
        #ui-header { position: absolute; top: 0; width: 100%; height: 85px; background: rgba(0,0,0,0.95); display: none; justify-content: space-between; align-items: center; z-index: 1000; border-bottom: 2px solid #333; padding: 5px 15px 0 15px; box-sizing: border-box; }
        .stat-group { display: flex; flex-direction: column; gap: 2px; min-width: 90px; }
        .stat-item { font-size: 13px; font-weight: bold; }
        .pause-btn { background: none; border: 1.5px solid white; color: white; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; }
        .overlay { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 6000; background: rgba(0,0,0,0.96); }
        .menu-box { background: #151515; padding: 20px; border-radius: 30px; border: 1px solid var(--neon); text-align: center; width: 90%; max-width: 400px; }
        .btn { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; color: white; background: #333; }
        .shop-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-height: 280px; overflow-y: auto; margin: 10px 0; padding: 10px; background: #111; border-radius: 15px; border: 1px solid #333; }
        .skin-item { background: #222; height: 70px; border-radius: 12px; border: 1px solid #444; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 24px; position: relative; transition: 0.2s; }
        .skin-item:active { transform: scale(0.9); background: #333; }
        .price-tag { font-size: 9px; font-weight: bold; margin-top: 5px; }
        .exchange-box { background: #1a2a1a; padding: 10px; border-radius: 15px; border: 1px dashed var(--green); margin-bottom: 10px; }
        #notify { position: fixed; top: 95px; left: 50%; transform: translateX(-50%); padding: 8px 15px; border-radius: 20px; font-size: 12px; display: none; z-index: 7000; font-weight: bold; }
    </style>
</head>
<body>

    <div id="notify"></div>

    <div id="loading-screen" class="overlay">
        <h2 style="color:var(--neon)">SAm CLOUD CONNECT...</h2>
        <p style="font-size:11px">ÿ¨ÿßÿ±Ÿä ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±</p>
    </div>

    <div id="main-menu" class="overlay" style="display:none">
        <h1 style="color:var(--neon); margin:0; letter-spacing: 2px;">BLOCKSAM</h1>
        <p style="font-size: 10px; color: #666; margin-bottom: 20px;">V2.9 | MONSTER UPDATE</p>
        <div class="menu-box">
            <button class="btn" style="background:var(--gold); color:black" onclick="startMode('solo')">SOLO MISSION</button>
            <button class="btn" style="background:var(--neon); color:black" onclick="startMode('multi')">VERSUS AI</button>
            <button class="btn" onclick="openShop()">MARKET (30 SKINS) üõí</button>
        </div>
    </div>

    <div id="shop-screen" class="overlay" style="display:none">
        <div class="menu-box">
            <h3 style="margin:0; color:var(--neon)">MEGA MARKET</h3>
            <div class="exchange-box">
                <button class="btn" style="background:var(--green); color:black; margin:0; font-size:11px" onclick="exchangeCoins()">
                    EXCHANGE: 50,000 üí∞ ‚ûî 10 üíµ
                </button>
            </div>
            <div class="shop-grid" id="shop-grid"></div>
            <button class="btn" style="background:#444" onclick="closeShop()">BACK</button>
        </div>
    </div>

    <div id="ui-header">
        <div class="stat-group" style="border-left: 3px solid var(--neon); padding-left: 8px;">
            <div id="cloud-id" style="color:#888; font-size:9px">SAm_Op</div>
            <div class="stat-item"><span id="p1-score-ui" style="color:var(--gold)">0</span> üí∞</div>
            <div class="stat-item"><span id="p1-cash-ui" style="color:var(--green)">0</span> üíµ</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 10px; color: var(--gold);">LVL: <span id="lvl-display">1</span></div>
            <button class="pause-btn" id="p-btn" onclick="togglePause()">‚è∏Ô∏è</button>
        </div>
        <div id="p2-ui" class="stat-group" style="border-right: 3px solid var(--red); padding-right: 8px; text-align: right; opacity: 0;">
            <div style="color:#888; font-size:9px">AI_BOT</div>
            <div class="stat-item">üí∞ <span id="p2-score-ui" style="color:var(--gold)">0</span></div>
            <div class="stat-item">üíµ <span id="p2-cash-ui" style="color:var(--green)">0</span></div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    const { Client, Account, Databases, ID, Query } = Appwrite;
    const client = new Client().setEndpoint('https://fra.cloud.appwrite.io/v1').setProject('69943f560019334ae3b5');
    const databases = new Databases(client);
    const account = new Account(client);
    const DB_ID = '69943bf8001373c3c286'; 
    const COL_ID = 'players';

    let playerDocId = null;
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;

    let game = { active: false, paused: false, level: 1 };
    let p1 = { x: 200, y: 300, tx: 200, ty: 300, score: 0, cash: 0, icon: 'ü•∑' };
    let p2 = { x: -100, y: -100, score: 0, cash: 0, icon: 'ü§ñ', active: false };
    let items = [], monsters = [], portal = { active: false };
    let p1_lives = 3;
    const monsterIcons = ['üëæ', 'üëª', 'üëπ', 'üë∫', 'üêâ', 'üëΩ', 'üíÄ', 'üßõ', 'üßü', 'üéÉ'];

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(f, t, d) {
        if(audioCtx.state === 'suspended') return;
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
        g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d);
        o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + d);
    }
    const sfx = {
        coin: () => playSound(800, 'sine', 0.1),
        cash: () => { playSound(600, 'triangle', 0.1); setTimeout(()=>playSound(900, 'triangle', 0.2), 50); },
        buy: () => { [400, 600, 900].forEach((f,i)=>setTimeout(()=>playSound(f, 'sine', 0.2), i*80)); }
    };

    const icons = ['ü•∑','ü¶ä','ü¶Å','üêº','üêØ','üëΩ','üê≤','üë∫','ü§°','üëª','ü§ñ','üê±','üê≠','üêπ','üê∞','üêª','üê®','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','üê¶','üê§','üê£','üê•','üëë','üíé','üî•'];
    const shopItems = icons.map((icon, i) => ({
        icon: icon, price: i < 5 ? (i === 0 ? 0 : 10000) : (10 + (i - 5) * 5), type: i < 5 ? 'coin' : 'cash'
    }));

    async function initCloud() {
        try {
            try { await account.createAnonymousSession(); } catch(e){}
            const user = await account.get();
            document.getElementById('cloud-id').innerText = "UID: " + user.$id.substring(0,5);
            const res = await databases.listDocuments(DB_ID, COL_ID, [Query.equal('user_id', user.$id)]);
            if (res.documents.length > 0) {
                const data = res.documents[0];
                playerDocId = data.$id;
                p1.score = data.coins || 0; p1.cash = data.cash || 0; p1.icon = data.current_skin || 'ü•∑';
            } else {
                const newDoc = await databases.createDocument(DB_ID, COL_ID, ID.unique(), {
                    user_id: user.$id, coins: 0, cash: 0, current_skin: 'ü•∑'
                });
                playerDocId = newDoc.$id;
            }
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        } catch (e) {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        }
    }

    async function sync() {
        if(playerDocId) {
            try { await databases.updateDocument(DB_ID, COL_ID, playerDocId, { coins: p1.score, cash: p1.cash, current_skin: p1.icon }); } catch(e){}
        }
    }

    function spawnMonster() {
        if (!game.active || game.paused) return;
        let monsterIndex = Math.min(game.level - 1, monsterIcons.length - 1);
        let monsterSize = 40 + (game.level * 5);
        monsters.push({
            x: Math.random() > 0.5 ? -50 : canvas.width + 50,
            y: Math.random() * canvas.height,
            speed: 1.2 + (game.level * 0.4), 
            icon: monsterIcons[monsterIndex],
            size: monsterSize
        });
    }

    function animate() {
        if (!game.active || game.paused) { requestAnimationFrame(animate); return; }
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // HUD - Hearts
        ctx.font = "20px Arial"; ctx.textAlign = "left";
        ctx.fillText("‚ù§Ô∏è".repeat(p1_lives), 20, 110);
        
        // Portal logic
        if (p1.score >= 10000 && !portal.active) { 
            portal.active = true; portal.x = canvas.width/2; portal.y = canvas.height/2; 
        }
        if (portal.active) {
            ctx.font = "60px serif"; ctx.textAlign = "center";
            ctx.fillText("üåÄ", portal.x, portal.y);
            if(Math.hypot(p1.x-portal.x, p1.y-portal.y)<50){ 
                game.level++; p1.score = 0; portal.active = false;
                p1_lives = Math.min(p1_lives + 1, 5); monsters = [];
                showMsg("LEVEL " + game.level + " UNLOCKED!", "purple"); sync(); 
            }
        }

        // P1 Movement
        p1.x += (p1.tx - p1.x) * 0.15; p1.y += (p1.ty - p1.y) * 0.15;
        ctx.font = "50px serif"; ctx.textAlign = "center";
        ctx.fillText(p1.icon, p1.x, p1.y);

        // AI Movement
        if (p2.active) {
            let target = items.find(i => i.active) || p1;
            p2.x += (target.x - p2.x) * 0.04; p2.y += (target.y - p2.y) * 0.04;
            ctx.fillText(p2.icon, p2.x, p2.y);
        }

        // Monsters logic
        monsters.forEach((m, index) => {
            let dx = p1.x - m.x; let dy = p1.y - m.y;
            let angle = Math.atan2(dy, dx);
            m.x += Math.cos(angle) * m.speed; m.y += Math.sin(angle) * m.speed;
            ctx.font = m.size + "px serif"; ctx.fillText(m.icon, m.x, m.y);
            if(Math.hypot(p1.x-m.x, p1.y-m.y) < (m.size * 0.7)) {
                monsters.splice(index, 1); p1_lives--;
                showMsg("HIT! -1 ‚ù§Ô∏è", "red"); playSound(150, 'sawtooth', 0.2);
                if(p1_lives <= 0) { alert("GAME OVER!"); location.reload(); }
            }
        });

        // Items logic
        items.forEach(it => {
            if(!it.active) return;
            ctx.font = "24px serif"; ctx.fillText(it.type==='cash'?"üíµ":"üí∞", it.x, it.y);
            if(Math.hypot(p1.x-it.x, p1.y-it.y)<35){ 
                it.active=false; if(it.type==='cash') { p1.cash++; sfx.cash(); } else { p1.score+=500; sfx.coin(); }
                if(p1.score % 5000 === 0) sync(); 
            }
        });

        document.getElementById('p1-score-ui').innerText = p1.score.toLocaleString();
        document.getElementById('p1-cash-ui').innerText = p1.cash;
        document.getElementById('lvl-display').innerText = game.level;
        if(p2.active){ document.getElementById('p2-score-ui').innerText = p2.score.toLocaleString(); document.getElementById('p2-cash-ui').innerText = p2.cash; }
        
        requestAnimationFrame(animate);
    }

    function openShop() {
        document.getElementById('shop-screen').style.display = 'flex';
        const grid = document.getElementById('shop-grid'); grid.innerHTML = '';
        shopItems.forEach((item, index) => {
            const div = document.createElement('div'); div.className = 'skin-item';
            div.innerHTML = `${item.icon}<div class="price-tag" style="color:${item.type==='cash'?'#2ecc71':'#ffd700'}">${item.price} ${item.type==='cash'?'üíµ':'üí∞'}</div>`;
            div.onclick = () => buySkin(index); grid.appendChild(div);
        });
    }

    function buySkin(i) {
        const item = shopItems[i];
        if (item.type === 'coin' && p1.score >= item.price) {
            if(item.price > 0) p1.score -= item.price;
            p1.icon = item.icon; showMsg("EQUIPPED!", "green"); sfx.buy(); sync();
        } else if (item.type === 'cash' && p1.cash >= item.price) {
            p1.cash -= item.price; p1.icon = item.icon; showMsg("VIP UNLOCKED!", "#bc13fe"); sfx.buy(); sync();
        } else showMsg("NOT ENOUGH FUNDS", "red");
        closeShop();
    }

    function exchangeCoins() {
        if (p1.score >= 50000) { p1.score -= 50000; p1.cash += 10; showMsg("+10 CASH!", "green"); sfx.cash(); sync(); }
        else showMsg("NEED 50,000 COINS", "red");
    }

    function startMode(m) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        game.active = true; document.getElementById('main-menu').style.display = 'none';
        document.getElementById('ui-header').style.display = 'flex';
        if(m === 'multi') { p2.active = true; document.getElementById('p2-ui').style.opacity = '1'; }
        animate();
    }

    function togglePause() { game.paused = !game.paused; document.getElementById('p-btn').innerText = game.paused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è'; }
    function closeShop() { document.getElementById('shop-screen').style.display = 'none'; }
    function showMsg(t, c) {
        const n = document.getElementById('notify'); n.innerText = t; n.style.background = c; n.style.display = 'block';
        setTimeout(() => n.style.display = 'none', 2000);
    }

    canvas.addEventListener('touchmove', (e) => { if(!game.paused){p1.tx = e.touches[0].clientX; p1.ty = Math.max(e.touches[0].clientY, 90); }});
    setInterval(() => { if(game.active && !game.paused) items.push({ x: Math.random()*(canvas.width-50)+25, y: Math.random()*(canvas.height-150)+100, type: Math.random()<0.06?'cash':'coin', active: true }); }, 1800);
    setInterval(spawnMonster, 3500);

    initCloud();
</script>
</body>
            </html>
