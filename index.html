<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BLOCKSAM - PRO EDITION</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
    <style>
        :root { --neon: #00f2ff; --gold: #ffd700; --green: #2ecc71; --red: #ff4757; --bg: #0a0a0a; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: sans-serif; color: white; }
        .overlay { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 6000; background: rgba(0,0,0,0.96); }
        .menu-box { background: #151515; padding: 25px; border-radius: 30px; border: 1px solid var(--neon); text-align: center; width: 85%; max-width: 400px; }
        .btn { width: 100%; padding: 14px; margin: 8px 0; border: none; border-radius: 15px; font-weight: bold; cursor: pointer; color: white; background: #333; transition: 0.3s; }
        #ui-header { position: absolute; top: 0; width: 100%; height: 90px; background: rgba(0,0,0,0.9); display: none; justify-content: space-between; align-items: center; z-index: 1000; border-bottom: 2px solid #222; padding: 10px 20px; box-sizing: border-box; }
        .stat-item { font-size: 14px; font-weight: bold; margin: 2px 0; }
        .shop-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-height: 200px; overflow-y: auto; margin: 15px 0; padding: 10px; background: #000; border-radius: 15px; }
        .skin-item { background: #1a1a1a; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; border: 1px solid #333; }
        .recharge-box { background: #0d1a0d; padding: 15px; border-radius: 20px; border: 1px dashed var(--green); margin-top: 10px; }
        #notify { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 25px; font-size: 12px; display: none; z-index: 7000; font-weight: bold; }
    </style>
</head>
<body>

    <div id="notify"></div>

    <div id="reward-screen" class="overlay" style="display:none">
        <div class="menu-box" style="border-color:var(--gold)">
            <h2 style="color:var(--gold)">ğŸ Ù‡Ø¯ÙŠØ© Ù…Ù€Ù„ÙƒÙŠØ©</h2>
            <p id="reward-msg" style="line-height:1.6"></p>
            <button class="btn" style="background:var(--gold); color:black" onclick="claimReward()">Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© ğŸš€</button>
        </div>
    </div>

    <div id="loading-screen" class="overlay">
        <h2 style="color:var(--neon)">BLOCKSAM CLOUD</h2>
        <p style="font-size:12px; color:#666">Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ±...</p>
    </div>

    <div id="main-menu" class="overlay" style="display:none">
        <h1 style="color:var(--neon); margin:0; letter-spacing:3px">BLOCKSAM</h1>
        <p style="font-size: 10px; color: #444; margin-bottom: 25px;">PRO V2.9 | SYNC SECURE</p>
        <div class="menu-box">
            <button class="btn" style="background:var(--gold); color:black" onclick="startGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨ ğŸ®</button>
            <button class="btn" onclick="openShop()">Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„Ø´Ø­Ù† ğŸ›’</button>
        </div>
    </div>

    <div id="shop-screen" class="overlay" style="display:none">
        <div class="menu-box">
            <h3 style="margin:0; color:var(--neon)">Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„Ø´Ø­Ù†</h3>
            <div class="shop-grid" id="shop-grid"></div>
            
            <div class="recharge-box">
                <div style="font-size:11px; color:var(--green); margin-bottom:8px; font-weight:bold">Ø´Ø­Ù† Orange Money</div>
                <button class="btn" style="background:var(--green); color:black; padding:10px; font-size:11px" onclick="goWhatsApp('Ø¨Ø§Ù‚Ø© 50 ÙƒØ§Ø´ / 20 Ø¬Ù†ÙŠÙ‡')">50 ğŸ’µ = 20 EGP</button>
                <button class="btn" style="background:var(--green); color:black; padding:10px; font-size:11px" onclick="goWhatsApp('Ø¨Ø§Ù‚Ø© 150 ÙƒØ§Ø´ / 50 Ø¬Ù†ÙŠÙ‡')">150 ğŸ’µ = 50 EGP</button>
            </div>
            <button class="btn" style="background:#444" onclick="closeShop()">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        </div>
    </div>

    <div id="ui-header">
        <div class="stat-group">
            <div class="stat-item" style="color:var(--gold)">ğŸ’° <span id="coins-ui">0</span></div>
            <div class="stat-item" style="color:var(--green)">ğŸ’µ <span id="cash-ui">0</span></div>
        </div>
        <div id="p-id" style="font-size:10px; color:#555">UID: --</div>
        <button class="btn" style="width:45px; margin:0" onclick="game.paused = !game.paused">â¸ï¸</button>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    const { Client, Account, Databases, ID, Query } = Appwrite;
    const client = new Client().setEndpoint('https://fra.cloud.appwrite.io/v1').setProject('69943f560019334ae3b5');
    const databases = new Databases(client);
    const account = new Account(client);

    const DB_ID = '69943bf8001373c3c286'; // Ø§Ù„Ù€ ID Ù…Ù† ØµÙˆØ±ØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰
    const COL_ID = 'players';            // Ø§Ù„Ù€ ID Ù…Ù† ØµÙˆØ±ØªÙƒ Ø§Ù„Ø«Ø§Ù†ÙŠØ©
    const MY_WA = "201287837118";

    let playerDocId = null;
    let p1 = { score: 0, cash: 0, icon: 'ğŸ¥·', x: 200, y: 300, tx: 200, ty: 300 };
    let game = { active: false, paused: false };

    async function init() {
        try {
            try { await account.createAnonymousSession(); } catch(e){}
            const user = await account.get();
            document.getElementById('p-id').innerText = "UID: " + user.$id.substring(0,6);

            const res = await databases.listDocuments(DB_ID, COL_ID, [Query.equal('user_id', user.$id)]);
            let data;
            if (res.documents.length > 0) {
                data = res.documents[0];
                playerDocId = data.$id;
                p1.score = data.coins || 0;
                p1.cash = data.cash || 0;
                p1.icon = data.current_skin || 'ğŸ¥·';
            } else {
                data = await databases.createDocument(DB_ID, COL_ID, ID.unique(), {
                    user_id: user.$id, coins: 0, cash: 0, current_skin: 'ğŸ¥·', last_login: 0, streak: 0
                });
                playerDocId = data.$id;
            }
            checkReward(data);
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        } catch (e) { alert("ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ Permissions ÙÙŠ Appwrite!"); }
    }

    function checkReward(data) {
        const now = Date.now();
        const last = data.last_login || 0;
        const day = 24 * 60 * 60 * 1000;

        if (now - last > day) {
            let streak = (now - last < 2 * day) ? (data.streak || 0) + 1 : 1;
            window.reward = { streak: streak };
            let m = "";
            if(streak === 1) { m = "Ø£ÙˆÙ„ ÙŠÙˆÙ… Ù„ÙŠÙƒ! Ø®Ø¯ÙŠ 1000 ÙƒÙˆÙŠÙ† ğŸ’°"; window.reward.val = 1000; window.reward.type = 'coin'; }
            else if(streak === 3) { m = "Ø¹Ø§Ø´! 3 Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©.. Ø®Ø¯ 5 ÙƒØ§Ø´ ğŸ’µ"; window.reward.val = 5; window.reward.type = 'cash'; }
            else if(streak >= 7) { m = "Ø£Ù†Øª Ø¨Ø·Ù„! Ø£Ø³Ø¨ÙˆØ¹ ÙƒØ§Ù…Ù„.. Ù‡Ø¯ÙŠØ© ØªØ§Ø¬ Ø§Ù„Ù…Ù„Ùƒ ğŸ‘‘"; window.reward.val = 'ğŸ‘‘'; window.reward.type = 'skin'; }
            else { m = `ÙŠÙˆÙ… ${streak} ÙÙŠ Ø§Ù„Ø³Ù„Ø³Ù„Ø©! Ø®Ø¯ 500 ÙƒÙˆÙŠÙ† ğŸ’°`; window.reward.val = 500; window.reward.type = 'coin'; }
            
            document.getElementById('reward-msg').innerText = m;
            document.getElementById('reward-screen').style.display = 'flex';
        }
    }

    async function claimReward() {
        const r = window.reward;
        if(r.type === 'coin') p1.score += r.val;
        else if(r.type === 'cash') p1.cash += r.val;
        else if(r.type === 'skin') p1.icon = r.val;

        await databases.updateDocument(DB_ID, COL_ID, playerDocId, {
            coins: p1.score, cash: p1.cash, current_skin: p1.icon, last_login: Date.now(), streak: r.streak
        });
        document.getElementById('reward-screen').style.display = 'none';
        showMsg("ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù‡Ø¯ÙŠØ©!", "var(--gold)");
    }

    function goWhatsApp(pack) {
        window.open(`https://wa.me/${MY_WA}?text=${encodeURIComponent('ÙŠØ§ SAm Ù…Ø­ØªØ§Ø¬ Ø£Ø´Ø­Ù† ' + pack)}`, '_blank');
    }

    function openShop() {
        document.getElementById('shop-screen').style.display = 'flex';
        const grid = document.getElementById('shop-grid'); grid.innerHTML = '';
        ['ğŸ¥·','ğŸ¦Š','ğŸ¦','ğŸ¼','ğŸ¯','ğŸ‘½','ğŸ²','ğŸ¤–','ğŸ‘‘','â­','ğŸ”¥','ğŸŒˆ'].forEach((icon, i) => {
            const div = document.createElement('div');
            div.className = 'skin-item';
            div.innerHTML = `${icon}<div style="font-size:8px; position:absolute; bottom:2px">${i<2?'FREE':(i*5)+'ğŸ’µ'}</div>`;
            div.onclick = () => { if(i<2 || p1.cash >= i*5){ p1.icon=icon; sync(); closeShop(); } };
            grid.appendChild(div);
        });
    }

    async function sync() {
        if(playerDocId) await databases.updateDocument(DB_ID, COL_ID, playerDocId, { coins: p1.score, cash: p1.cash, current_skin: p1.icon });
    }

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;

    function startGame() {
        game.active = true; document.getElementById('main-menu').style.display = 'none';
        document.getElementById('ui-header').style.display = 'flex';
        animate();
    }

    function animate() {
        if (!game.active || game.paused) { requestAnimationFrame(animate); return; }
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        p1.x += (p1.tx - p1.x) * 0.1; p1.y += (p1.ty - p1.y) * 0.1;
        ctx.font = "45px serif"; ctx.textAlign = "center"; ctx.fillText(p1.icon, p1.x, p1.y);
        document.getElementById('coins-ui').innerText = p1.score;
        document.getElementById('cash-ui').innerText = p1.cash;
        requestAnimationFrame(animate);
    }

    canvas.addEventListener('touchmove', (e) => { p1.tx = e.touches[0].clientX; p1.ty = e.touches[0].clientY; });
    function closeShop() { document.getElementById('shop-screen').style.display = 'none'; }
    function showMsg(t, c) { const n = document.getElementById('notify'); n.innerText = t; n.style.background = c; n.style.display = 'block'; setTimeout(() => n.style.display = 'none', 2000); }

    init();
</script>
</body>
                                                                                                   </html>
