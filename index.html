<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BLOCKSAM PRO v2.1</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
    <style>
        :root { --neon: #00f2ff; --gold: #ffd700; --bg: #0a0a0a; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: sans-serif; color: white; touch-action: none; }
        #ui-header { position: absolute; top: 0; width: 100%; height: 70px; background: rgba(0,0,0,0.8); display: none; justify-content: space-between; align-items: center; padding: 0 20px; box-sizing: border-box; z-index: 1000; border-bottom: 1px solid var(--neon); }
        .overlay { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 6000; background: rgba(0,0,0,0.95); }
        .btn { width: 220px; padding: 15px; margin: 10px; border-radius: 15px; font-weight: bold; cursor: pointer; border: none; background: var(--gold); color: black; font-size: 18px; box-shadow: 0 0 15px rgba(255,215,0,0.3); }
    </style>
</head>
<body>

    <div id="loading-screen" class="overlay">
        <h2 style="color:var(--neon)">SAm CLOUD READY</h2>
        <p>Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
    </div>

    <div id="main-menu" class="overlay" style="display:none">
        <h1 style="color:var(--neon)">BLOCKSAM v2.1</h1>
        <button class="btn" onclick="startGame()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© ðŸŽ®</button>
        <p style="font-size:12px; color:#555">Cloud Sync: Active âœ…</p>
    </div>

    <div id="ui-header">
        <div style="color:var(--gold)">ðŸ’° <span id="coins-ui">0</span></div>
        <div style="color:#2ecc71">ðŸ’µ <span id="cash-ui">0</span></div>
        <div id="p-id" style="font-size:10px; color:#555">UID: --</div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Appwrite (Ø§Ù„Ù„ÙŠ ØªØ£ÙƒØ¯Ù†Ø§ Ø¥Ù†Ù‡Ø§ Ø´ØºØ§Ù„Ø©) ---
    const { Client, Account, Databases, ID, Query } = Appwrite;
    const client = new Client().setEndpoint('https://fra.cloud.appwrite.io/v1').setProject('69943f560019334ae3b5');
    const databases = new Databases(client);
    const account = new Account(client);
    const DB_ID = '69943bf8001373c3c286'; 
    const COL_ID = 'players';

    let playerDocId = null;
    let p1 = { score: 0, cash: 0, icon: 'ðŸ¥·', x: window.innerWidth/2, y: window.innerHeight/2, tx: window.innerWidth/2, ty: window.innerHeight/2 };
    let gameActive = false;
    let coins = [];

    // --- ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ---
    async function init() {
        try {
            try { await account.createAnonymousSession(); } catch(e){}
            const user = await account.get();
            document.getElementById('p-id').innerText = "ID: " + user.$id.substring(0,5);

            const res = await databases.listDocuments(DB_ID, COL_ID, [Query.equal('user_id', user.$id)]);
            if (res.documents.length > 0) {
                const data = res.documents[0];
                playerDocId = data.$id;
                p1.score = data.coins || 0;
                p1.cash = data.cash || 0;
            } else {
                const newDoc = await databases.createDocument(DB_ID, COL_ID, ID.unique(), {
                    user_id: user.$id, coins: 0, cash: 0, current_skin: 'ðŸ¥·'
                });
                playerDocId = newDoc.$id;
            }
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        } catch (e) {
            console.error(e);
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        }
    }

    function startGame() {
        gameActive = true;
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('ui-header').style.display = 'flex';
        // ØªÙˆÙ„ÙŠØ¯ Ø¹Ù…Ù„Ø§Øª Ø£ÙˆÙ„ÙŠØ©
        for(let i=0; i<5; i++) spawnCoin();
        animate();
    }

    function spawnCoin() {
        coins.push({ x: Math.random()*window.innerWidth, y: Math.random()*(window.innerHeight-100)+80, active: true });
    }

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    function animate() {
        if (!gameActive) return;
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¨Ø³Ù„Ø§Ø³Ø©
        p1.x += (p1.tx - p1.x) * 0.1;
        p1.y += (p1.ty - p1.y) * 0.1;

        // Ø±Ø³Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Øª
        coins.forEach(c => {
            if(!c.active) return;
            ctx.font = "30px serif";
            ctx.fillText("ðŸ’°", c.x, c.y);
            // ØªØµØ§Ø¯Ù…
            if(Math.hypot(p1.x - c.x, p1.y - c.y) < 40) {
                c.active = false;
                p1.score += 10;
                document.getElementById('coins-ui').innerText = p1.score;
                spawnCoin();
                if(p1.score % 50 === 0) syncData(); // Ù…Ø²Ø§Ù…Ù†Ø© ÙƒÙ„ 50 Ù†Ù‚Ø·Ø©
            }
        });

        // Ø±Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨
        ctx.font = "50px serif";
        ctx.textAlign = "center";
        ctx.fillText(p1.icon, p1.x, p1.y);

        requestAnimationFrame(animate);
    }

    async function syncData() {
        if(playerDocId) {
            try {
                await databases.updateDocument(DB_ID, COL_ID, playerDocId, { coins: p1.score });
                console.log("Data Synced âœ…");
            } catch(e) {}
        }
    }

    window.addEventListener('touchstart', (e) => {
        p1.tx = e.touches[0].clientX;
        p1.ty = e.touches[0].clientY;
    });
    window.addEventListener('touchmove', (e) => {
        p1.tx = e.touches[0].clientX;
        p1.ty = e.touches[0].clientY;
    });

    init();
</script>
</body>
</html>
