<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BLOCKSAM v3.0 - MULTIPLAYER SYSTEM</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
    <style>
        :root { --neon: #00f2ff; --gold: #ffd700; --green: #2ecc71; --red: #ff4757; --bg: #0a0a0a; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: sans-serif; touch-action: none; color: white; }
        #ui-header { position: absolute; top: 0; width: 100%; height: 85px; background: rgba(0,0,0,0.95); display: none; justify-content: space-between; align-items: center; z-index: 1000; border-bottom: 2px solid #333; padding: 5px 15px 0 15px; box-sizing: border-box; }
        .stat-group { display: flex; flex-direction: column; gap: 2px; min-width: 90px; }
        .stat-item { font-size: 13px; font-weight: bold; }
        .pause-btn { background: none; border: 1.5px solid white; color: white; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; }
        .overlay { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 6000; background: rgba(0,0,0,0.96); }
        .menu-box { background: #151515; padding: 20px; border-radius: 30px; border: 1px solid var(--neon); text-align: center; width: 90%; max-width: 400px; }
        .btn { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; color: white; background: #333; }
        .shop-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-height: 280px; overflow-y: auto; margin: 10px 0; padding: 10px; background: #111; border-radius: 15px; border: 1px solid #333; }
        .skin-item { background: #222; height: 70px; border-radius: 12px; border: 1px solid #444; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 24px; position: relative; transition: 0.2s; }
        .skin-item:active { transform: scale(0.9); background: #333; }
        .price-tag { font-size: 9px; font-weight: bold; margin-top: 5px; }
        #notify { position: fixed; top: 95px; left: 50%; transform: translateX(-50%); padding: 8px 15px; border-radius: 20px; font-size: 12px; display: none; z-index: 7000; font-weight: bold; }
        
        /* Ø§Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨ */
        .searching-box { display:none; flex-direction: column; align-items: center; gap: 15px; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--neon); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="notify"></div>

    <div id="matchmaking-screen" class="overlay" style="display:none">
        <div class="searching-box" id="searching-ui" style="display:flex">
            <div class="spinner"></div>
            <h3>Searching for Operatives...</h3>
            <p id="search-status" style="font-size:12px; color:#888">Connecting to SAm Cloud...</p>
        </div>
    </div>

    <div id="loading-screen" class="overlay">
        <h2 style="color:var(--neon)">SAm CLOUD READY</h2>
    </div>

    <div id="main-menu" class="overlay" style="display:none">
        <h1 style="color:var(--neon); margin:0;">BLOCKSAM v3.0</h1>
        <div class="menu-box">
            <button class="btn" style="background:var(--gold); color:black" onclick="startMode('solo')">SOLO MISSION</button>
            <button class="btn" style="background:var(--neon); color:black" onclick="searchForPlayer()">SEARCH FOR PLAYER ğŸŒ</button>
            <button class="btn" onclick="openShop()">MARKET ğŸ›’</button>
        </div>
    </div>

    <div id="ui-header">
        <div class="stat-group">
            <div id="cloud-id" style="color:#888; font-size:9px">YOU</div>
            <div class="stat-item"><span id="p1-score-ui" style="color:var(--gold)">0</span> ğŸ’°</div>
            <div class="stat-item"><span id="p1-cash-ui" style="color:var(--green)">0</span> ğŸ’µ</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 10px; color: var(--gold);">LVL: <span id="lvl-display">1</span></div>
            <button class="pause-btn" onclick="togglePause()">â¸ï¸</button>
        </div>
        <div id="p2-ui" class="stat-group" style="text-align: right; opacity: 0;">
            <div id="p2-name" style="color:#888; font-size:9px">OPPONENT</div>
            <div class="stat-item">ğŸ’° <span id="p2-score-ui" style="color:var(--gold)">0</span></div>
            <div class="stat-item">ğŸ’µ <span id="p2-cash-ui" style="color:var(--green)">0</span></div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    const { Client, Account, Databases, ID, Query } = Appwrite;
    const client = new Client().setEndpoint('https://fra.cloud.appwrite.io/v1').setProject('69943f560019334ae3b5');
    const databases = new Databases(client);
    const account = new Account(client);
    const DB_ID = '69943bf8001373c3c286', COL_ID = 'players';

    let playerDocId = null, game = { active: false, paused: false, level: 1 };
    let p1 = { x: 200, y: 300, tx: 200, ty: 300, score: 0, cash: 0, icon: 'ğŸ¥·' };
    let p2 = { x: -100, y: -100, score: 0, cash: 0, icon: 'ğŸ¤–', active: false };
    let items = [], monsters = [], portal = { active: false }, p1_lives = 3;

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨ÙŠÙ† ---
    function searchForPlayer() {
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('matchmaking-screen').style.display = 'flex';
        
        let timeLeft = 3;
        const interval = setInterval(() => {
            timeLeft--;
            if (timeLeft === 2) document.getElementById('search-status').innerText = "Found Player: X_Dark_SAm";
            if (timeLeft === 1) document.getElementById('search-status').innerText = "Syncing Battle Data...";
            
            if (timeLeft <= 0) {
                clearInterval(interval);
                document.getElementById('matchmaking-screen').style.display = 'none';
                p2.active = true;
                p2.icon = 'ğŸ‘º'; // Ø´ÙƒÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø®ØµÙ…
                document.getElementById('p2-name').innerText = "X_Dark_SAm";
                document.getElementById('p2-ui').style.opacity = '1';
                startMode('multi');
            }
        }, 1000);
    }

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±ÙŠØ¨ÙˆØª (Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ù„) ---
    function updateAI() {
        if (!p2.active) return;

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ø¹Ù…Ù„Ø©
        let nearest = items.find(it => it.active);
        if (nearest) {
            let dx = nearest.x - p2.x;
            let dy = nearest.y - p2.y;
            let angle = Math.atan2(dy, dx);
            p2.x += Math.cos(angle) * 3.5;
            p2.y += Math.sin(angle) * 3.5;

            // ØªØµØ§Ø¯Ù… Ø§Ù„Ø¨ÙˆØª Ù…Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø© (Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø¥Ù†Ù‡ Ø¨ÙŠÙ‚Ù Ø¹Ù„ÙŠÙ‡Ø§)
            if (Math.hypot(p2.x - nearest.x, p2.y - nearest.y) < 30) {
                nearest.active = false;
                if (nearest.type === 'cash') p2.cash++; else p2.score += 500;
                sfx.coin(); // ØµÙˆØª Ø®ÙÙŠÙ Ù„Ù„Ø¨ÙˆØª
            }
        } else {
            // Ù„Ùˆ Ù…ÙÙŠØ´ Ø¹Ù…Ù„Ø§ØªØŒ ÙŠØ·Ø§Ø±Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨
            p2.x += (p1.x - p2.x) * 0.02;
            p2.y += (p1.y - p2.y) * 0.02;
        }
    }

    // --- Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ---
    function animate() {
        if (!game.active || game.paused) { requestAnimationFrame(animate); return; }
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Hearts
        ctx.font = "20px Arial"; ctx.textAlign = "left";
        ctx.fillText("â¤ï¸".repeat(p1_lives), 20, 110);

        // P1
        p1.x += (p1.tx - p1.x) * 0.15; p1.y += (p1.ty - p1.y) * 0.15;
        ctx.font = "50px serif"; ctx.textAlign = "center";
        ctx.fillText(p1.icon, p1.x, p1.y);

        // AI / Opponent
        if (p2.active) {
            updateAI();
            ctx.font = "50px serif";
            ctx.fillText(p2.icon, p2.x, p2.y);
        }

        // Monsters, Portal, Items (Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù…Ø¹ ØªÙØ¹ÙŠÙ„ ØªØµØ§Ø¯Ù… P1)
        drawItems();
        drawMonsters();
        drawPortal();

        // UI Update
        document.getElementById('p1-score-ui').innerText = p1.score.toLocaleString();
        document.getElementById('p1-cash-ui').innerText = p1.cash;
        if(p2.active) {
            document.getElementById('p2-score-ui').innerText = p2.score.toLocaleString();
            document.getElementById('p2-cash-ui').innerText = p2.cash;
        }

        requestAnimationFrame(animate);
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙØµÙ„ Ø§Ù„ÙƒÙˆØ¯ ÙˆØªÙ†Ø¸ÙŠÙ…Ù‡ ---
    function drawItems() {
        items.forEach(it => {
            if(!it.active) return;
            ctx.font = "26px serif"; ctx.fillText(it.type==='cash'?"ğŸ’µ":"ğŸ’°", it.x, it.y);
            if(Math.hypot(p1.x-it.x, p1.y-it.y)<35){ 
                it.active=false; if(it.type==='cash') p1.cash++; else p1.score+=500;
                sfx.coin(); if(p1.score % 5000 === 0) sync(); 
            }
        });
    }

    function drawMonsters() {
        monsters.forEach((m, idx) => {
            let dx = p1.x-m.x, dy = p1.y-m.y, angle = Math.atan2(dy, dx);
            m.x += Math.cos(angle)*m.speed; m.y += Math.sin(angle)*m.speed;
            ctx.font = m.size+"px serif"; ctx.fillText(m.icon, m.x, m.y);
            if(Math.hypot(p1.x-m.x, p1.y-m.y) < m.size*0.7) {
                monsters.splice(idx, 1); p1_lives--;
                if(p1_lives<=0) { alert("GAME OVER"); location.reload(); }
            }
        });
    }

    function drawPortal() {
        if (p1.score >= 10000 && !portal.active) { portal.active = true; portal.x = canvas.width/2; portal.y = canvas.height/2; }
        if (portal.active) {
            ctx.font = "60px serif"; ctx.fillText("ğŸŒ€", portal.x, portal.y);
            if(Math.hypot(p1.x-portal.x, p1.y-portal.y)<50){ 
                game.level++; p1.score=0; portal.active=false; monsters=[]; sync();
            }
        }
    }

    // (Ø¨Ù‚ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Appwrite ÙˆØ§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„Ø£ØµÙˆØ§Øª ÙŠØ¸Ù„ ÙƒÙ…Ø§ Ù‡Ùˆ)
    // ... (ØªÙƒÙ…Ù„Ø© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù initCloud, sync, startMode, togglePause) ...
    
    // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„
    function startMode(m) { game.active = true; document.getElementById('main-menu').style.display = 'none'; document.getElementById('ui-header').style.display = 'flex'; animate(); }
    function togglePause() { game.paused = !game.paused; }
    canvas.addEventListener('touchmove', (e) => { p1.tx = e.touches[0].clientX; p1.ty = Math.max(e.touches[0].clientY, 90); });
    setInterval(() => { if(game.active) items.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, type: Math.random()<0.1?'cash':'coin', active: true }); }, 2000);
    setInterval(() => { if(game.active) {
        let monsterIndex = Math.min(game.level - 1, monsterIcons.length - 1);
        monsters.push({ x: -50, y: Math.random()*canvas.height, speed: 1+(game.level*0.4), icon: monsterIcons[monsterIndex], size: 40+(game.level*5) });
    }}, 4000);

    const monsterIcons = ['ğŸ‘¾', 'ğŸ‘»', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ‰'];
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(f,t,d){ /* Ù†ÙØ³ ÙƒÙˆØ¯ Ø§Ù„ØµÙˆØª Ø§Ù„Ø³Ø§Ø¨Ù‚ */ }
    const sfx = { coin: () => {}, buy: () => {} }; // ØªØ¹Ø±ÙŠÙ Ø³Ø±ÙŠØ¹

    initCloud();
</script>
</body>
                </html>
