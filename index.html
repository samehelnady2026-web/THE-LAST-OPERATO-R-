<!DOCTYPE html>
<html lang="ar">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BLOCKSAM v1.0 - MEGA MARKET</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
    <style>
        :root { --neon: #00f2ff; --gold: #ffd700; --green: #2ecc71; --red: #ff4757; --purple: #bc13fe; --bg: #0a0a0a; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: sans-serif; touch-action: none; color: white; }
        
        /* Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
        #ui-header { position: absolute; top: 0; width: 100%; height: 85px; background: rgba(0,0,0,0.95); display: none; justify-content: space-between; align-items: center; z-index: 1000; border-bottom: 2px solid #333; padding: 5px 15px 0 15px; box-sizing: border-box; }
        .stat-group { display: flex; flex-direction: column; gap: 2px; min-width: 90px; }
        .stat-item { font-size: 13px; font-weight: bold; }
        .pause-btn { background: none; border: 1.5px solid white; color: white; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; }

        /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
        .overlay { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 6000; background: rgba(0,0,0,0.96); }
        .menu-box { background: #151515; padding: 20px; border-radius: 30px; border: 1px solid var(--neon); text-align: center; width: 90%; max-width: 400px; }
        .btn { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; color: white; background: #333; transition: 0.2s; }
        .btn:active { transform: scale(0.95); }

        /* Ø§Ù„Ù…ØªØ¬Ø± */
        .shop-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-height: 250px; overflow-y: auto; margin: 10px 0; padding: 10px; background: #111; border-radius: 15px; border: 1px solid #222; }
        .skin-item { background: #222; height: 80px; border-radius: 12px; border: 1px solid #444; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; position: relative; }
        .price-tag { font-size: 9px; margin-top: 6px; font-weight: bold; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© */
        #nuke-btn { position: fixed; bottom: 30px; right: 30px; width: 70px; height: 70px; background: var(--red); border-radius: 50%; border: 3px solid white; font-size: 30px; display: none; z-index: 5000; box-shadow: 0 0 20px var(--red); }
        #notify { position: fixed; top: 95px; left: 50%; transform: translateX(-50%); padding: 8px 15px; border-radius: 20px; font-size: 12px; display: none; z-index: 7000; font-weight: bold; text-align: center; }

        /* Ø²Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ */
        .wa-btn { background: #25D366; color: white; text-decoration: none; padding: 12px; border-radius: 12px; display: block; margin-top: 10px; font-size: 14px; font-weight: bold; border: 1px solid #fff; }
    </style>
</head>
<body>

    <div id="notify"></div>
    <button id="nuke-btn" onclick="useNuke()">ğŸ’£</button>

    <div id="loading-screen" class="overlay"><h2 style="color:var(--neon)">SAM CLOUD CONNECT...</h2></div>

    <div id="main-menu" class="overlay" style="display:none">
        <h1 style="color:var(--neon); margin:0;">BLOCKSAM v1.0</h1>
        <div class="menu-box">
            <button class="btn" style="background:var(--gold); color:black" onclick="startMode('solo')">SOLO MISSION</button>
            <button class="btn" style="background:var(--neon); color:black" onclick="searchForPlayer()">SEARCH FOR PLAYER ğŸŒ</button>
            <button class="btn" onclick="openShop()">MARKET ğŸ›’</button>
            <button id="install-btn" class="btn" style="display:none; background:white; color:black;">INSTALL APP ğŸ“²</button>
        </div>
    </div>

    <div id="shop-screen" class="overlay" style="display:none">
        <div class="menu-box">
            <h3 style="color:var(--purple); margin:0;">EXCHANGE & ITEMS</h3>
            <button class="btn" style="background:var(--gold); color:black; font-size:11px" onclick="exchangeCoinsForCash()">CONVERT: 50,000 ğŸ’° â” 10 ğŸ’µ</button>
            <button class="btn" style="background:var(--red)" onclick="buyNuke()">BUY NUKE ğŸ’£ (10 ğŸ’µ)</button>
            
            <h3 style="color:var(--neon); margin-top:10px; margin-bottom:5px;">SKINS</h3>
            <div id="shop-grid" class="shop-grid"></div>
            
            <a href="https://wa.me/201287837118?text=Ø£Ù†Ø§ Ø¹Ø§ÙˆØ² Ø£Ø´Ø­Ù† ÙƒØ§Ø´ ÙÙŠ Ù„Ø¹Ø¨Ø© Blocksam" target="_blank" class="wa-btn">RECHARGE CASH ğŸ’¬ (01287837118)</a>
            
            <button class="btn" onclick="closeShop()" style="margin-top:10px">BACK</button>
        </div>
    </div>

    <div id="ui-header">
        <div class="stat-group">
            <div style="color:#888; font-size:9px">SAM_Op</div>
            <div class="stat-item"><span id="p1-score-ui" style="color:var(--gold)">0</span> ğŸ’°</div>
            <div class="stat-item"><span id="p1-cash-ui" style="color:var(--green)">0</span> ğŸ’µ</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 10px; color: var(--gold);">LVL: <span id="lvl-display">1</span></div>
            <button class="pause-btn" onclick="togglePause()">â¸ï¸</button>
        </div>
        <div id="p2-ui" class="stat-group" style="text-align: right; opacity: 0;">
            <div style="color:#888; font-size:9px">Dark_SAM</div>
            <div class="stat-item">ğŸ’° <span id="p2-score-ui" style="color:var(--gold)">0</span></div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    // --- ğŸ”Š Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(freq, type, duration) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type; 
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    }

    // --- ğŸ“± Ù†Ø¸Ø§Ù… Ø§Ù„Ù€ PWA ---
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault(); deferredPrompt = e;
        document.getElementById('install-btn').style.display = 'block';
    });

    // --- â˜ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª APPWRITE ---
    const { Client, Account, Databases, ID, Functions } = Appwrite;
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;

    const client = new Client().setEndpoint('https://fra.cloud.appwrite.io/v1').setProject('69943f560019334ae3b5');
    const databases = new Databases(client);
    const account = new Account(client);

    const DB_ID = '69943bf8001373c3c286', COL_ID = 'players';
    let playerDocId = localStorage.getItem('blocksam_id');
    let game = { active: false, paused: false, level: 1, nukes: 0 };
    let p1 = { x: 200, y: 300, tx: 200, ty: 300, score: 0, cash: 0, icon: 'ğŸ¥·' };
    let items = [], monsters = [], p1_lives = 3;

    // --- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¬Ø± ---
    const skinsData = [
        {icon:'ğŸ¥·', price:0, type:'coin'}, {icon:'ğŸ¦Š', price:2000, type:'coin'}, {icon:'ğŸ¦', price:5000, type:'coin'},
        {icon:'ğŸ‘½', price:5, type:'cash'}, {icon:'ğŸ²', price:10, type:'cash'}, {icon:'ğŸ¤–', price:30, type:'cash'}
    ];

    async function initCloud() {
        try {
            try { await account.createAnonymousSession(); } catch(e){}
            if (playerDocId) {
                const doc = await databases.getDocument(DB_ID, COL_ID, playerDocId);
                p1.score = doc.coins; p1.cash = doc.cash; p1.icon = doc.current_skin;
            } else { await createNewUser(); }
        } catch(e) { console.log("Cloud Error"); }
        hideLoading();
    }

    async function createNewUser() {
        const d = await databases.createDocument(DB_ID, COL_ID, ID.unique(), { coins: 0, cash: 0, current_skin: 'ğŸ¥·' });
        playerDocId = d.$id; localStorage.setItem('blocksam_id', playerDocId);
    }

    function hideLoading() {
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('main-menu').style.display = 'flex';
    }

    async function sync() {
        if(!playerDocId) return;
        try {
            await databases.updateDocument(DB_ID, COL_ID, playerDocId, { 
                coins: p1.score, cash: p1.cash, current_skin: p1.icon 
            });
        } catch(e) {}
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© ---
    function exchangeCoinsForCash() {
        if(p1.score >= 50000) {
            p1.score -= 50000; p1.cash += 10;
            playSound(800, 'square', 0.2);
            showMsg("ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! +10 ğŸ’µ", "var(--green)"); sync();
        } else {
            playSound(150, 'sawtooth', 0.3);
            showMsg("Ù…Ø­ØªØ§Ø¬ 50,000 ÙƒÙˆÙŠÙ†!", "var(--red)");
        }
    }

    function buySkin(index) {
        const s = skinsData[index];
        if (s.type === 'coin' && p1.score >= s.price) {
            p1.score -= s.price; p1.icon = s.icon; playSound(600, 'sine', 0.2); sync();
        } else if (s.type === 'cash' && p1.cash >= s.price) {
            p1.cash -= s.price; p1.icon = s.icon; playSound(900, 'sine', 0.3); sync();
        }
        openShop();
    }

    function buyNuke() {
        if(p1.cash >= 10) { 
            p1.cash -= 10; game.nukes++; playSound(400, 'square', 0.4); sync();
        } else showMsg("Ù…Ø­ØªØ§Ø¬ 10 ÙƒØ§Ø´!", "orange");
    }

    function openShop() {
        document.getElementById('shop-screen').style.display = 'flex';
        const grid = document.getElementById('shop-grid'); grid.innerHTML = '';
        skinsData.forEach((s, i) => {
            const d = document.createElement('div'); d.className = 'skin-item';
            d.innerHTML = `<div>${s.icon}</div><div class="price-tag">${s.price}</div>`;
            d.onclick = () => buySkin(i); grid.appendChild(d);
        });
    }

    function closeShop() { document.getElementById('shop-screen').style.display = 'none'; }

    function startMode() {
        game.active = true;
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('ui-header').style.display = 'flex';
        animate();
    }

    function animate() {
        if (!game.active || game.paused) { requestAnimationFrame(animate); return; }
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Ø±Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨
        p1.x += (p1.tx - p1.x) * 0.15; p1.y += (p1.ty - p1.y) * 0.15;
        ctx.font = "50px serif"; ctx.fillText(p1.icon, p1.x, p1.y);

        // Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙˆØ§Ù„ÙˆØ­ÙˆØ´
        items.forEach((it, i) => {
            ctx.font = "30px serif"; ctx.fillText(it.type==='cash'?"ğŸ’µ":"ğŸ’°", it.x, it.y);
            if(Math.hypot(p1.x-it.x, p1.y-it.y) < 40) {
                items.splice(i,1); 
                if(it.type==='cash') { p1.cash++; playSound(1200, 'sine', 0.1); } 
                else { p1.score+=500; playSound(800, 'sine', 0.1); }
                sync();
            }
        });

        document.getElementById('p1-score-ui').innerText = p1.score;
        document.getElementById('p1-cash-ui').innerText = p1.cash;
        requestAnimationFrame(animate);
    }

    function showMsg(t, c) { 
        const n = document.getElementById('notify'); n.innerText = t; 
        n.style.background = c; n.style.display = 'block'; 
        setTimeout(()=>n.style.display='none', 2000); 
    }

    canvas.addEventListener('touchmove', (e) => { p1.tx = e.touches[0].clientX; p1.ty = e.touches[0].clientY; });
    setInterval(() => { if(game.active) items.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, type: Math.random()<0.08?'cash':'coin' }); }, 2000);

    initCloud();
</script>
</body>
                </html>
